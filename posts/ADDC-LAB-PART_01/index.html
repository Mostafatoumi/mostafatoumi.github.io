<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing" /><meta property="og:locale" content="en" /><meta name="description" content="Setting Up a Windows Server for Penetration Testing with Active Directory" /><meta property="og:description" content="Setting Up a Windows Server for Penetration Testing with Active Directory" /><link rel="canonical" href="/posts/ADDC-LAB-PART_01/" /><meta property="og:url" content="/posts/ADDC-LAB-PART_01/" /><meta property="og:site_name" content="Mostafa Toumi" /><meta property="og:image" content="/assets/img/favicons/HackTheBox/ADDC-LAB/lab_01.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-20T13:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/favicons/HackTheBox/ADDC-LAB/lab_01.png" /><meta property="twitter:title" content="Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing" /><meta name="twitter:site" content="@EmSec0" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-22T16:31:19+01:00","datePublished":"2022-11-20T13:00:00+01:00","description":"Setting Up a Windows Server for Penetration Testing with Active Directory","headline":"Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing","image":"/assets/img/favicons/HackTheBox/ADDC-LAB/lab_01.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/ADDC-LAB-PART_01/"},"url":"/posts/ADDC-LAB-PART_01/"}</script><title>Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing | Mostafa Toumi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mostafa Toumi"><meta name="application-name" content="Mostafa Toumi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/Mostafatoumi/mostafatoumi.github.io/main/assets/img/favicons/HackTheBox/emsec_1.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Mostafa Toumi</a></div><div class="site-subtitle font-italic">Computer Networking Specialist | Penetration Tester | CTF Player</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Mostafatoumi" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/EmSec0" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['Mostafatoumi0','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.hackthebox.com/home/users/profile/962022" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://www.linkedin.com/in/mostafatoumi/" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1668945600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 20, 2022 </em> </span> <span> Updated <em class="" data-ts="1700667079" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 22, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/img/favicons/HackTheBox/ADDC-LAB/lab_01.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/lab_01.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/EmSec0">Mostafa Toumi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3220 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p><strong>Setting Up a Windows Server for Penetration Testing with Active Directory</strong></p><h2 id="1-introduction-"><span class="mr-2"><strong><strong><font color="Brown">1. Introduction </font></strong></strong></span><a href="#1-introduction-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="overview-of-the-blogs-purpose-"><span class="mr-2"><strong><strong><font color="DarkCyan">Overview of the blog's purpose :</font></strong></strong></span><a href="#overview-of-the-blogs-purpose-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Welcome to the Active Directory Pentesting Blog, your ultimate guide for constructing a robust and secure Windows Server environment crafted specifically for penetration testing. Whether youâ€™re a beginner or an experienced professional, this blog aims to offer a comprehensive guide to help you build your own penetration testing lab</p><h3 id="importance-of-a-controlled-environment-for-penetration-testing-"><span class="mr-2"><strong><strong><font color="DarkCyan">Importance of a controlled environment for penetration testing :</font></strong></strong></span><a href="#importance-of-a-controlled-environment-for-penetration-testing-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In the realm of cybersecurity, the significance of a controlled environment for penetration testing cannot be overstated. A controlled environment provides a safe and isolated space where ethical hackers, security professionals, and enthusiasts can simulate real-world cyber threats without compromising the integrity of live systems. Hereâ€™s why it matters:</p><ul><li><code class="language-plaintext highlighter-rouge">Risk Mitigation</code> :</ul><p>Enables safe exploration without the risk of damaging live systems.</p><ul><li>Realistic Scenarios:</ul><p>Mimics real-world conditions, providing a close-to-reality testing environment.</p><ul><li><code class="language-plaintext highlighter-rouge">Skill Development</code> :</ul><p>Offers a hands-on learning ground for system administration, network security, and ethical hacking.</p><ul><li><code class="language-plaintext highlighter-rouge">Confidentiality and Compliance</code> :</ul><p>Protects sensitive data, ensuring compliance with regulatory requirements.</p><ul><li><code class="language-plaintext highlighter-rouge">Iterative Testing</code> :</ul><p>Facilitates continuous improvement by refining strategies based on test outcomes.</p><ul><li><code class="language-plaintext highlighter-rouge">Ethical Practices</code> :</ul><p>Promotes ethical and responsible hacking, emphasizing constructive use of hacking skills.</p><h2 id="2-lab-setup"><span class="mr-2"><strong><strong><font color="Brown">2. Lab Setup</font></strong></strong></span><a href="#2-lab-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="hardware-and-software-requirements-"><span class="mr-2"><strong><strong><font color="DarkCyan">Hardware and software requirements :</font></strong></strong></span><a href="#hardware-and-software-requirements-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To establish a robust penetration testing lab with Windows Server 2012 as the Active Directory Domain Controller (AD DC) server, Windows 10 as the client machine, and Kali Linux for attacking, ensure your hardware and software meet the following requirements:</p><h3 id="hardware-requirements"><span class="mr-2"><strong><strong><font color="DarkCyan">Hardware Requirements:</font></strong></strong></span><a href="#hardware-requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Server Machine (Windows Server 2012 r2):</ul><div class="table-wrapper"><table><thead><tr><th>Component<th>Specification<tbody><tr><td><code class="language-plaintext highlighter-rouge">Processor</code><td>Dual-core processor or higher.<tr><td><code class="language-plaintext highlighter-rouge">RAM</code><td>2 GB or more.<tr><td><code class="language-plaintext highlighter-rouge">Storage</code><td>50 GB or more for the operating system and additional space for virtual machines.</table></div><ul><li>Client Machine (Windows 10):</ul><div class="table-wrapper"><table><thead><tr><th>Component<th>Specification<tbody><tr><td><code class="language-plaintext highlighter-rouge">Processor</code><td>Dual-core processor or higher.<tr><td><code class="language-plaintext highlighter-rouge">RAM</code><td>2 GB or more.<tr><td><code class="language-plaintext highlighter-rouge">Storage</code><td>30 GB or more for the operating system and applications.</table></div><ul><li>Attacking Machine (Kali Linux):</ul><div class="table-wrapper"><table><thead><tr><th>Component<th>Specification<tbody><tr><td><code class="language-plaintext highlighter-rouge">Processor</code><td>Dual-core processor or higher.<tr><td><code class="language-plaintext highlighter-rouge">RAM</code><td>2 GB or more.<tr><td><code class="language-plaintext highlighter-rouge">Storage</code><td>30 GB or more for the operating system and tools.</table></div><h3 id="software-requirements-"><span class="mr-2"><strong><strong><font color="DarkCyan">Software Requirements :</font></strong></strong></span><a href="#software-requirements-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Windows Server 2012 R2 :</ul><p>You can Download ISO of Windows SERVER 2012 r1 from <a href="https://info.microsoft.com/ww-landing-windows-server-2012-R2.html?lcid=fr">here</a></p><ul><li>Windows 10 :</ul><p>You can Download Windows 10 from <a href="https://www.microsoft.com/fr-fr/software-download/windows10">here</a></p><ul><li>Kali Linux :</ul><p>Choose any OS for penetration testing; I recommend using <a href="https://www.kali.org/get-kali/#kali-installer-images">Kali linux</a> for optimal results.</p><h3 id="virtualization-platform-"><span class="mr-2"><strong><strong><font color="DarkCyan">Virtualization Platform :</font></strong></strong></span><a href="#virtualization-platform-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Choose a virtualization platform like <a href="https://www.vmware.com/fr/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation Pro</a> or <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> for creating and managing virtual machines.</p><h2 id="3-basic-configuration-"><span class="mr-2"><strong><strong><font color="Brown">3. Basic Configuration </font></strong></strong></span><a href="#3-basic-configuration-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="configuration-script-"><span class="mr-2"><strong><strong><font color="DarkCyan">Configuration script :</font></strong></strong></span><a href="#configuration-script-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Windows Server 2012 r2 :</p><div class="table-wrapper"><table><thead><tr><th>Component<th>Specification<tbody><tr><td><code class="language-plaintext highlighter-rouge">MACHINE NAME</code><td>SRV-1<tr><td><code class="language-plaintext highlighter-rouge">IPv4 Address</code><td>10.10.10.10/8<tr><td><code class="language-plaintext highlighter-rouge">Mask</code><td>255.0.0.0<tr><td><code class="language-plaintext highlighter-rouge">DNS</code><td>127.0.0.1 (We will make changes to this in part 2 as we need to create a DNS server)<tr><td><code class="language-plaintext highlighter-rouge">ANTIVIRUS</code><td><span style="color:green">ENABLE </span><tr><td><code class="language-plaintext highlighter-rouge">FIREWALL</code><td><span style="color:red">DISABLE</span></table></div><p>Why disable the firewall? Because the firewall might block ICMP connections between the host server and the client, as well as the client to the server. Alternatively, you would have to allow these ports through the firewall settings</p><p>Windows 10 (clients) and kali linux :</p><p>For simplicity, we will assign the following IP addresses: Client 1 - 10.10.10.20, Client 2 - 10.10.10.30, and Kali Linux - 10.10.10.40</p><p><em><span style="color:red"> Note </span>: The DNS and default gateway will be set to the serverâ€™s address, which is 10.10.10.10.</em></p><p>I think that is clear. Now, letâ€™s configure this setup</p><h3 id="adding-second-interface-in-vmware-"><span class="mr-2"><strong><strong><font color="DarkCyan">Adding Second Interface in VMware :</font></strong></strong></span><a href="#adding-second-interface-in-vmware-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After installing Windows Server 2012, Windows 10, and Kali Linux, the next step is to configure the network. Create a second bridged virtual network adapter directed to the second card and add it to the Virtual Machine. Why? This is done to isolate this LAN segment, enabling seamless communication among these machines. The first interface ensures internet connectivity for downloading or upgrading system components.</p><p>To add a new network adapter, navigate to <code class="language-plaintext highlighter-rouge">Settings of SRV Machine &gt; click add</code> (make sure the first interface is <code class="language-plaintext highlighter-rouge">NAT</code> for Internet connection)</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_01.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_01.png" alt="vm interface" class="lazyload" data-proofer-ignore></a></p><p>Select <code class="language-plaintext highlighter-rouge">Network Adapter</code> and click <code class="language-plaintext highlighter-rouge">Finish</code></p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_02.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_02.png" alt="vm interface" class="lazyload" data-proofer-ignore></a> Create a LAN Segment called â€˜LAB.LOCALâ€™ <a href="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_03.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_03.png" alt="vm interface" class="lazyload" data-proofer-ignore></a> Link This LAN segment with the second interface <a href="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_04.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/interface_config_04.png" alt="vm interface" class="lazyload" data-proofer-ignore></a></p><p><em><span style="color:red"> Note </span>: You can follow the same previous steps for all machines.</em></p><h3 id="configuring-networking-static-ip-dns-settings"><span class="mr-2"><strong><strong><font color="DarkCyan">Configuring networking (static IP, DNS settings).</font></strong></strong></span><a href="#configuring-networking-static-ip-dns-settings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Windows Server 2012 r2 :</p><p>By default Ethenet0 is the first interface and the second interface that we added is Ethernet1 . To set a static IP for Ethernet1 in Windows using CMD, you can use the following commands (<code class="language-plaintext highlighter-rouge">win + R</code> &amp; <code class="language-plaintext highlighter-rouge">cmd</code> ):</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/WIN-R.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/WIN-R.png" alt="WIN + R" class="lazyload" data-proofer-ignore></a></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c">#IP Address</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">10</span><span class="w"> </span><span class="mf">255.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">1</span><span class="w">
</span><span class="c">#DNS</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">dns</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">127.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">1</span><span class="w">

</span><span class="c">#Changeing Name of Machine</span><span class="w">
</span><span class="n">netdom</span><span class="w"> </span><span class="nx">renamecomputer</span><span class="w"> </span><span class="o">%</span><span class="nx">COMPUTERNAME</span><span class="o">%</span><span class="w"> </span><span class="nx">/newname:SRV-1</span><span class="w"> </span><span class="nx">/reboot:0</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/Interface-SRV-1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/Interface-SRV-1.png" alt="interface Eth1 SRV-1" class="lazyload" data-proofer-ignore></a></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">#To disable Firewall</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">off</span><span class="w">
</span><span class="c">#If you want to enable it later</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">on</span><span class="w">

</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/firewall-SRV-1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/firewall-SRV-1.png" alt="firewall" class="lazyload" data-proofer-ignore></a></p><p>Windows 10 (Clinet-1 &amp; Clinet-2):</p><ul><li>Client-1 :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c">#IP Address</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">20</span><span class="w"> </span><span class="mf">255.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">10</span><span class="w">

</span><span class="c">#DNS (address of AD server)</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">dns</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">10</span><span class="w">

</span><span class="c"># Changing Name of Machine</span><span class="w">
</span><span class="n">netdom</span><span class="w"> </span><span class="nx">renamecomputer</span><span class="w"> </span><span class="o">%</span><span class="nx">COMPUTERNAME</span><span class="o">%</span><span class="w"> </span><span class="nx">/newname:user-1</span><span class="w"> </span><span class="nx">/reboot:0</span><span class="w">

</span><span class="c">#To disable Firewall</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">off</span><span class="w">
</span><span class="c">#If you want to enable it later</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">on</span><span class="w">
</span></pre></table></code></div></div><ul><li>Client-2 :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c">#IP Address</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">30</span><span class="w"> </span><span class="mf">255.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">10</span><span class="w">

</span><span class="c">#DNS (address of AD server)</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">ipv4</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">dns</span><span class="w"> </span><span class="nx">name</span><span class="o">=</span><span class="s2">"Ethernet1"</span><span class="w"> </span><span class="kr">static</span><span class="w"> </span><span class="mf">10.10</span><span class="o">.</span><span class="nf">10</span><span class="o">.</span><span class="nf">10</span><span class="w">

</span><span class="c"># Changing Name of Machine</span><span class="w">
</span><span class="n">netdom</span><span class="w"> </span><span class="nx">renamecomputer</span><span class="w"> </span><span class="o">%</span><span class="nx">COMPUTERNAME</span><span class="o">%</span><span class="w"> </span><span class="nx">/newname:user-2</span><span class="w"> </span><span class="nx">/reboot:0</span><span class="w">

</span><span class="c">#To disable Firewall</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">off</span><span class="w">
</span><span class="c">#If you want to enable it later</span><span class="w">
</span><span class="n">netsh</span><span class="w"> </span><span class="nx">advfirewall</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">allprofiles</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">on</span><span class="w">
</span></pre></table></code></div></div><ul><li>Kali Linux :</ul><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># IP Address</span>
<span class="nb">sudo </span>ifconfig eth1 10.10.10.40 netmask 255.0.0.0
<span class="c"># DNS</span>
<span class="nb">sudo </span>ip route add default via 10.10.10.10 dev eth1
<span class="c"># Activate The Interface </span>
<span class="nb">sudo </span>ip <span class="nb">link set </span>eth1 up
</pre></table></code></div></div><h3 id="testing-the-connectivity-"><span class="mr-2"><strong><strong><font color="DarkCyan">Testing The connectivity :</font></strong></strong></span><a href="#testing-the-connectivity-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We have completed the basic configuration of the machines and the necessary settings. Now, itâ€™s time to test the connectivity, ensuring it works both from the server to the client and from the client to the server.</p><ul><li>From Kali linux to SRV1 :</ul><p>The connection is successful between Kali Linux (attacker) and SRVE-1 (Windows Server 2012)</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/kali-To-SRV-1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/kali-To-SRV-1.png" alt="PING TEST " class="lazyload" data-proofer-ignore></a></p><ul><li>From SRV1 To Kali:</ul><p>Itâ€™s fine too</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/SRV-1-To-Kali.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/SRV-1-To-Kali.png" alt="PING TEST " class="lazyload" data-proofer-ignore></a></p><p><em><span style="color:red"> Note </span>: If the connectivity fails, check the firewall settings as mentioned earlier.</em></p><p>You can follow the same steps to check the connectivity between the clients and SRVE-1, as well as with Kali Linux.</p><h3 id="diagram-"><span class="mr-2"><strong><strong><font color="DarkCyan">Diagram :</font></strong></strong></span><a href="#diagram-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/diagram_02.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/diagram_02.png" alt="Lab" class="lazyload" data-proofer-ignore></a></p><h2 id="4-active-directory-domain-controller-setup"><span class="mr-2"><strong><strong><font color="Brown">4. Active Directory Domain Controller Setup</font></strong></strong></span><a href="#4-active-directory-domain-controller-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="installing-the-active-directory-domain-services-role-"><span class="mr-2"><strong><strong><font color="DarkCyan">Installing the Active Directory Domain Services role :</font></strong></strong></span><a href="#installing-the-active-directory-domain-services-role-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>While Windows Server 2012 provides a graphical user interface (GUI) method for adding features such as the Active Directory module, weâ€™ll take a detour and explore the command-line prowess of PowerShell. Why? Because embracing PowerShell not only enhances your scripting skills but also offers a more efficient and scalable way to manage and automate tasks. So, letâ€™s skip the GUI this time and dive into the powerful world of PowerShell for our Active Directory module installation.</p><div class="table-wrapper"><table><thead><tr><th>Component<th>Specification<tbody><tr><td><code class="language-plaintext highlighter-rouge">Domain Name</code><td>DC.LAB.LOCAL<tr><td><code class="language-plaintext highlighter-rouge">Password</code><td>Pen_lab@2023!</table></div><ul><li><strong>Open PowerShell as Administrator</strong></ul><p>Right-click on the PowerShell icon and choose <code class="language-plaintext highlighter-rouge">Run as Administrator</code> to ensure elevated privileges.</p><ul><li><strong>Install the Active Directory Module</strong></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Install-WindowsFeature</span><span class="w"> </span><span class="nx">AD-Domain-Services</span><span class="w"> </span><span class="nt">-IncludeManagementTools</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/AD_installation.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/AD_installation.png" alt="install AD " class="lazyload" data-proofer-ignore></a></p><ul><li><strong>Creating the domain and forest.</strong></ul><p>So, the domain name will be <code class="language-plaintext highlighter-rouge">dc.lab.local</code>, and the password is <code class="language-plaintext highlighter-rouge">Pen_lab@2023!</code>. The domain installation process may take from 2 to 5 minutes. During the installation, PowerShell will prompt you to restart the machine. Choose <code class="language-plaintext highlighter-rouge">Y</code> or <code class="language-plaintext highlighter-rouge">Yes</code> and wait until the installation completes and the machine reboots</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Install-ADDSForest</span><span class="w"> </span><span class="nt">-DomainName</span><span class="w"> </span><span class="nx">dc.lab.local</span><span class="w"> </span><span class="nt">-InstallDNS</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/creating_domain.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/creating_domain.png" alt="creating domain" class="lazyload" data-proofer-ignore></a></p><p>After the machine reboots, the name of our domain will appear in <code class="language-plaintext highlighter-rouge">Server Manager</code> under <code class="language-plaintext highlighter-rouge">Local Server</code> :</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/info_domain.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/info_domain.png" alt="info domain" class="lazyload" data-proofer-ignore></a></p><p>checking by <code class="language-plaintext highlighter-rouge">Get-ADdoamin</code> command, This will show you information about your new <code class="language-plaintext highlighter-rouge">Domain</code> :</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/get-addomain.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/get-addomain.png" alt="Get-addoamin" class="lazyload" data-proofer-ignore></a></p><p>Now, everything looks great. We have successfully created our domain <code class="language-plaintext highlighter-rouge">dc.lab.local</code>. Letâ€™s move on to the user and group management section.</p><h2 id="5-user-and-group-management"><span class="mr-2"><strong><strong><font color="Brown">5. User and Group Management</font></strong></strong></span><a href="#5-user-and-group-management" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="adding-users-and-groups-to-the-domain-"><span class="mr-2"><strong><strong><font color="DarkCyan">Adding users and groups to the domain :</font></strong></strong></span><a href="#adding-users-and-groups-to-the-domain-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that our <code class="language-plaintext highlighter-rouge">Active Directory</code> is up and running, letâ€™s dive into user and group managementâ€”a crucial aspect of network security. In this scenario, imagine weâ€™re setting up a lab for a fictional organization called <code class="language-plaintext highlighter-rouge">"TechSecure Corp."</code></p><h3 id="user-creation-"><span class="mr-2"><strong><strong><font color="DarkCyan">User Creation :</font></strong></strong></span><a href="#user-creation-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong><code class="language-plaintext highlighter-rouge">User 1</code> : Alice Green</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Username</code> :</em> alice.green<li><em><code class="language-plaintext highlighter-rouge">Role</code> :</em> Junior Administrator</ul><li><strong><code class="language-plaintext highlighter-rouge">User 2</code> : Bob Smith</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Username</code> :</em> bob.smith<li><em><code class="language-plaintext highlighter-rouge">Role</code> :</em> Developer</ul><li><strong><code class="language-plaintext highlighter-rouge">User 3</code>: Emma White</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Username</code> :</em> emma.white<li><em><code class="language-plaintext highlighter-rouge">Role</code> :</em> QA Tester</ul></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># Create Users</span><span class="w">
</span><span class="n">New-ADUser</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Alice Green"</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="s2">"alice.green"</span><span class="w"> </span><span class="nt">-UserPrincipalName</span><span class="w"> </span><span class="s2">"alice.green@techsecure.local"</span><span class="w"> </span><span class="nt">-Title</span><span class="w"> </span><span class="s2">"Junior Administrator"</span><span class="w"> </span><span class="nt">-Enabled</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="s2">"Alice@2023!"</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w">
</span><span class="n">New-ADUser</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Bob Smith"</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="s2">"bob.smith"</span><span class="w"> </span><span class="nt">-UserPrincipalName</span><span class="w"> </span><span class="s2">"bob.smith@techsecure.local"</span><span class="w"> </span><span class="nt">-Title</span><span class="w"> </span><span class="s2">"Developer"</span><span class="w"> </span><span class="nt">-Enabled</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="s2">"Bob@2023!"</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w">
</span><span class="n">New-ADUser</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Emma White"</span><span class="w"> </span><span class="nt">-SamAccountName</span><span class="w"> </span><span class="s2">"emma.white"</span><span class="w"> </span><span class="nt">-UserPrincipalName</span><span class="w"> </span><span class="s2">"emma.white@techsecure.local"</span><span class="w"> </span><span class="nt">-Title</span><span class="w"> </span><span class="s2">"QA Tester"</span><span class="w"> </span><span class="nt">-Enabled</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="nt">-AccountPassword</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-SecureString</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w"> </span><span class="s2">"Emma@2023!"</span><span class="w"> </span><span class="nt">-Force</span><span class="p">)</span><span class="w">

</span></pre></table></code></div></div><h3 id="organizing-users-into-groups-"><span class="mr-2"><strong><strong><font color="DarkCyan">Organizing Users into Groups :</font></strong></strong></span><a href="#organizing-users-into-groups-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong>Group 1 : Admins</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Members</code> :</em> Alice Green<li><em><code class="language-plaintext highlighter-rouge">Permissions</code> :</em> Full administrative access to servers and Active Directory.</ul><li><strong>Group 2 : Developers</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Members</code> :</em> Bob Smith<li><em><code class="language-plaintext highlighter-rouge">Permissions</code> :</em> Access to development resources and shared project folders.</ul><li><strong>Group 3 : Testers</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Members</code> :</em> Emma White<li><em><code class="language-plaintext highlighter-rouge">Permissions</code> :</em> Limited access to testing environments and relevant resources.</ul></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Create Groups</span><span class="w">
</span><span class="n">New-ADGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Admins"</span><span class="w"> </span><span class="nt">-GroupScope</span><span class="w"> </span><span class="nx">Global</span><span class="w"> </span><span class="nt">-GroupCategory</span><span class="w"> </span><span class="nx">Security</span><span class="w">
</span><span class="n">New-ADGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Developers"</span><span class="w"> </span><span class="nt">-GroupScope</span><span class="w"> </span><span class="nx">Global</span><span class="w"> </span><span class="nt">-GroupCategory</span><span class="w"> </span><span class="nx">Security</span><span class="w">
</span><span class="n">New-ADGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Testers"</span><span class="w"> </span><span class="nt">-GroupScope</span><span class="w"> </span><span class="nx">Global</span><span class="w"> </span><span class="nt">-GroupCategory</span><span class="w"> </span><span class="nx">Security</span><span class="w">
</span></pre></table></code></div></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Add Users to Groups</span><span class="w">
</span><span class="n">Add-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Admins"</span><span class="w"> </span><span class="nt">-Members</span><span class="w"> </span><span class="s2">"alice.green"</span><span class="w">
</span><span class="n">Add-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Developers"</span><span class="w"> </span><span class="nt">-Members</span><span class="w"> </span><span class="s2">"bob.smith"</span><span class="w">
</span><span class="n">Add-ADGroupMember</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"Testers"</span><span class="w"> </span><span class="nt">-Members</span><span class="w"> </span><span class="s2">"emma.white"</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/AD_users.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/AD_users.png" alt="users" class="lazyload" data-proofer-ignore></a></p><h3 id="assigning-appropriate-permissions-"><span class="mr-2"><strong><strong><font color="DarkCyan">Assigning Appropriate Permissions :</font></strong></strong></span><a href="#assigning-appropriate-permissions-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h5 id="file-server-permissions-"><span class="mr-2"><strong>File Server Permissions :</strong></span><a href="#file-server-permissions-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li><strong>Shared Project Folder :</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Group Access</code> :</em> Developers have read/write access; Testers have read-only access.</ul><li><strong>Admin Access :</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Administrators</code> :</em> Full control over shared resources.</ul></ul><h5 id="active-directory-permissions-"><span class="mr-2"><strong>Active Directory Permissions :</strong></span><a href="#active-directory-permissions-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li><strong>Admin Group:</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Admins Group</code> :</em> Full control over Active Directory settings.</ul><li><strong>User Management :</strong><ul><li><em><code class="language-plaintext highlighter-rouge">Developers Group</code>:</em> Limited user management capabilities for their team members.<li><em><code class="language-plaintext highlighter-rouge">Testers Group</code>:</em> Basic user information access for their team members.</ul></ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="w">
</span><span class="c"># Note  : This is a simplified example. In a real-world scenario, you would replace placeholders with actual file paths and server details.*</span><span class="w">

</span><span class="c"># Create Folder C:\SharedProjects</span><span class="w">
</span><span class="n">mkdir</span><span class="w"> </span><span class="nx">C:\SharedProjects</span><span class="w">

</span><span class="c">#Assume shared project folder is located at `"C:\SharedProjects"`</span><span class="w">

</span><span class="nv">$projectFolderPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\SharedProjects"</span><span class="w">
</span><span class="nv">$adminsGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"Admins"</span><span class="p">}</span><span class="w">
</span><span class="nv">$developersGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"Developers"</span><span class="p">}</span><span class="w">
</span><span class="nv">$testersGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="p">{</span><span class="n">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"Testers"</span><span class="p">}</span><span class="w">

</span><span class="c"># Grant permissions on the shared project folder</span><span class="w">
</span><span class="c"># Administrators have full control</span><span class="w">
</span><span class="n">icacls</span><span class="w"> </span><span class="nv">$projectFolderPath</span><span class="w"> </span><span class="nx">/grant</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$adminsGroup</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">:(F)"</span><span class="w">
</span><span class="c"># Developers have read/write access</span><span class="w">
</span><span class="n">icacls</span><span class="w"> </span><span class="nv">$projectFolderPath</span><span class="w"> </span><span class="nx">/grant</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$developersGroup</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">:(R,W)"</span><span class="w">
</span><span class="c"># Testers have read-only access</span><span class="w">
</span><span class="n">icacls</span><span class="w"> </span><span class="nv">$projectFolderPath</span><span class="w"> </span><span class="nx">/grant</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$testersGroup</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">:(R)"</span><span class="w">

</span><span class="c"># Assign Active Directory Permissions</span><span class="w">
</span><span class="c"># Assume AD paths for user management and admin group</span><span class="w">
</span><span class="nv">$userManagementPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"OU=Users,DC=dc,DC=lab,DC=local"</span><span class="w">
</span><span class="nv">$adminGroupPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CN=Admins,OU=Groups,DC=dc,DC=lab,DC=local"</span><span class="w">
</span></pre></table></code></div></div><p>The Admins group has full control, and the Testers have read permission on the C:\SharedProjects folder. However, Developers have special permissions. Even though we provide read and write permissions, what does that mean? Each file or folder has 18 types of permissions. Six of those are <code class="language-plaintext highlighter-rouge">basic permissions</code> visible under the Security tab, while the remaining 12 are <code class="language-plaintext highlighter-rouge">advanced permissions</code> exposed in advanced mode only. These advanced permissions are set automatically. Any modifications to the advanced permissions are flagged by a tick mark in the <code class="language-plaintext highlighter-rouge">Special Permissions</code> box.</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/shared_folder_perm.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/shared_folder_perm.png" alt="folder dev perm" class="lazyload" data-proofer-ignore></a></p><h3 id="real-world-application-"><span class="mr-2"><strong><strong><font color="DarkCyan">Real-world Application :</font></strong></strong></span><a href="#real-world-application-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><em>*Scenario:</em> Alice, a Junior Administrator, needs to create user accounts for new developers joining the team. She adds them to the Developers group, granting them the necessary permissions on the file server. Meanwhile, Bob, a Developer, requires access to project-related resources, which is facilitated through his group membership.*</p><p>This scenario provides a glimpse into how user and group management in Active Directory plays out in a practical setting. Stay tuned as we explore the dynamic realm of <code class="language-plaintext highlighter-rouge">Group Policy Configuration</code> in the upcoming blog post!</p><h3 id="diagram--1"><span class="mr-2"><strong><strong><font color="DarkCyan">Diagram :</font></strong></strong></span><a href="#diagram--1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/diagram_03.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/diagram_03.png" alt="Diagram 2" class="lazyload" data-proofer-ignore></a></p><h2 id="6-move-users-to-an-organizational-unit"><span class="mr-2"><strong><strong><font color="Brown">6. Move Users To an Organizational Unit</font></strong></strong></span><a href="#6-move-users-to-an-organizational-unit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>An <code class="language-plaintext highlighter-rouge">OU</code> is a container within a Microsoft Windows Active Directory (AD) domain that can hold <code class="language-plaintext highlighter-rouge">users</code>, <code class="language-plaintext highlighter-rouge">groups</code> and <code class="language-plaintext highlighter-rouge">computers</code>. It is the smallest unit to which an administrator can assign <code class="language-plaintext highlighter-rouge">Group Policy settings</code> or account permissions.</p><p>To streamline the application of Group Policy Objects (<code class="language-plaintext highlighter-rouge">GPO</code>), we need to create two Organizational Units (<code class="language-plaintext highlighter-rouge">OUs</code>), one for developers and another for QA Tester users. Letâ€™s proceed with this configuration.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Create Developers OU</span><span class="w">
</span><span class="n">New-ADOrganizationalUnit</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Developers"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"DC=dc,DC=lab,DC=local"</span><span class="w">
</span><span class="c"># Create QA Testers OU</span><span class="w">
</span><span class="n">New-ADOrganizationalUnit</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"QA Testers"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"DC=dc,DC=lab,DC=local"</span><span class="w">
</span></pre></table></code></div></div><p>With the OUs added, our next step is to move users into their respective OUs.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Moving emma.white user to QA Testers OU</span><span class="w">
 </span><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"emma.white"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Move-ADObject</span><span class="w"> </span><span class="nt">-TargetPath</span><span class="w"> </span><span class="s2">"OU=QA Testers,DC=dc,DC=lab,DC=local"</span><span class="w">
 </span><span class="c"># Move bob.smith user to Developers OU</span><span class="w">
 </span><span class="n">Get-ADUser</span><span class="w"> </span><span class="nt">-Identity</span><span class="w"> </span><span class="s2">"bob.smith"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Move-ADObject</span><span class="w"> </span><span class="nt">-TargetPath</span><span class="w"> </span><span class="s2">"OU=Developers,DC=dc,DC=lab,DC=local"</span><span class="w">
</span></pre></table></code></div></div><p>We have successfully added users to OUs. Letâ€™s proceed to the Group Policy Objects (<code class="language-plaintext highlighter-rouge">GPO</code>) section. <a href="/assets/img/favicons/HackTheBox/ADDC-LAB/add_users2Ou.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/add_users2Ou.png" alt="add user to ou" class="lazyload" data-proofer-ignore></a></p><h2 id="7-group-policy-configuration"><span class="mr-2"><strong><strong><font color="Brown">7. Group Policy Configuration</font></strong></strong></span><a href="#7-group-policy-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As we continue our journey through <code class="language-plaintext highlighter-rouge">Active Directory mastery</code>, we arrive at the fascinating realm of <code class="language-plaintext highlighter-rouge">Group Policy Configuration</code>. In this scenario, weâ€™re tasked with enhancing the security posture of <code class="language-plaintext highlighter-rouge">TechSecure Corp</code>, our fictional organization.</p><h3 id="creating-and-applying-group-policies-for-security--"><span class="mr-2"><strong><strong><font color="DarkCyan">Creating and Applying Group Policies for Security : </font></strong></strong></span><a href="#creating-and-applying-group-policies-for-security--" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="password-complexity-policy-"><span class="mr-2"><strong>Password Complexity Policy :</strong></span><a href="#password-complexity-policy-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Strengthen password security to thwart unauthorized access</p><div class="table-wrapper"><table><thead><tr><th>Syntax<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">Group Policy Setting</code><td>1.Creating a Group Policy Object (GPO) named <code class="language-plaintext highlighter-rouge">PasswordPolicy</code>.<tr><td>Â <td>2.Configuring the password complexity settings :<tr><td>Â <td>- Minimum password length: 10 characters.<tr><td>Â <td>- Require at least one uppercase letter, one lowercase letter, one digit, and one special character.<tr><td><code class="language-plaintext highlighter-rouge">Application</code><td>Apply this <code class="language-plaintext highlighter-rouge">GPO</code> to the entire domain to enforce consistent password policies.</table></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c"># Creating Password Complexity Policy GPO</span><span class="w">
</span><span class="n">New-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"PasswordPolicy"</span><span class="w"> 
</span><span class="nv">$PasswordPolicyGPO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"PasswordPolicy"</span><span class="w">
</span><span class="n">Set-GPRegistryValue</span><span class="w"> </span><span class="nt">-Guid</span><span class="w"> </span><span class="nv">$PasswordPolicyGPO</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"</span><span class="w"> </span><span class="nt">-ValueName</span><span class="w"> </span><span class="s2">"MaxPasswordAge"</span><span class="w"> </span><span class="nt">-Type</span><span class="w"> </span><span class="nx">DWord</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">0</span><span class="w">

</span><span class="c"># Link the GPO to the domain</span><span class="w">
</span><span class="nv">$domainName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dc.lab.local"</span><span class="w">
</span><span class="nv">$gpoName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PasswordPolicy"</span><span class="w">
</span><span class="nv">$gpo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$gpoName</span><span class="w">
</span><span class="n">New-GPLink</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$gpo</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w"> </span><span class="nt">-Target</span><span class="w"> </span><span class="nv">$domainName</span><span class="w"> </span><span class="nt">-LinkEnabled</span><span class="w"> </span><span class="nx">Yes</span><span class="w">

</span></pre></table></code></div></div><h4 id="account-lockout-policy"><span class="mr-2"><strong>Account Lockout Policy:</strong></span><a href="#account-lockout-policy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Mitigate the risk of <code class="language-plaintext highlighter-rouge">brute force attacks</code> by implementing account lockout measures.</p><div class="table-wrapper"><table><thead><tr><th>Syntax<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">Group Policy Setting</code><td>1. Create a GPO named <code class="language-plaintext highlighter-rouge">AccountLockoutPolicy</code>.<tr><td>Â <td>2. Set account lockout threshold to 3 invalid login attempts, with a lockout duration of <code class="language-plaintext highlighter-rouge">15 minutes</code>.<tr><td><code class="language-plaintext highlighter-rouge">Application</code><td>Apply this <code class="language-plaintext highlighter-rouge">GPO</code> to the domain controllers to safeguard against unauthorized access attempts.</table></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c"># Creating Account Lockout Policy GPO</span><span class="w">
</span><span class="n">New-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"AccountLockoutPolicy"</span><span class="w">
</span><span class="nv">$AccountLockoutPolicyGPO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"AccountLockoutPolicy"</span><span class="w">
</span><span class="n">Set-GPRegistryValue</span><span class="w"> </span><span class="nt">-Guid</span><span class="w"> </span><span class="nv">$AccountLockoutPolicyGPO</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"</span><span class="w"> </span><span class="nt">-ValueName</span><span class="w"> </span><span class="s2">"LockoutDuration"</span><span class="w"> </span><span class="nt">-Type</span><span class="w"> </span><span class="nx">DWord</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">900</span><span class="w">

</span><span class="c"># Linking GPO to specific OUs</span><span class="w">
</span><span class="nv">$ouDistinguishedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"OU=Developers,DC=dc,DC=lab,DC=local"</span><span class="w">
</span><span class="nv">$gpoName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AccountLockoutPolicy"</span><span class="w">
</span><span class="nv">$gpo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$gpoName</span><span class="w">
</span><span class="n">New-GPLink</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$gpo</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w"> </span><span class="nt">-Target</span><span class="w"> </span><span class="nv">$ouDistinguishedName</span><span class="w"> </span><span class="nt">-LinkEnabled</span><span class="w"> </span><span class="nx">Yes</span><span class="w">

</span></pre></table></code></div></div><h4 id="restricting-command-line-access-"><span class="mr-2"><strong>Restricting Command-Line Access :</strong></span><a href="#restricting-command-line-access-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Employees in the <code class="language-plaintext highlighter-rouge">RestrictedUsers</code> group should be denied access to cmd and PowerShell. So we need to Limit command-line access for certain users to prevent misuse.</p><div class="table-wrapper"><table><thead><tr><th>Syntax<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">Group Policy Setting</code><td>1.Creating a GPO named <code class="language-plaintext highlighter-rouge">CmdPowerShellRestriction</code><tr><td>Â <td>2.Utilizing the Software Restriction Policies under Windows Settings to create a path rule denying execution for <code class="language-plaintext highlighter-rouge">cmd.exe</code> and <code class="language-plaintext highlighter-rouge">powershell.exe</code> for the <code class="language-plaintext highlighter-rouge">RestrictedUsers</code> group.<tr><td><code class="language-plaintext highlighter-rouge">Application</code><td>Applying this <code class="language-plaintext highlighter-rouge">GPO</code> specifically to the <code class="language-plaintext highlighter-rouge">RestrictedUsers</code> group to enforce the restriction.</table></div><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c"># Creating Restricting Command-Line Access GPO</span><span class="w">
</span><span class="n">New-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"CmdPowerShellRestriction"</span><span class="w"> 
</span><span class="nv">$CmdPowerShellRestrictionGPO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-GPO</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"CmdPowerShellRestriction"</span><span class="w">

</span><span class="n">Set-GPRegistryValue</span><span class="w"> </span><span class="nt">-Guid</span><span class="w"> </span><span class="nv">$CmdPowerShellRestrictionGPO</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Policies\Microsoft\Windows\Safer\CodeIdentifiers\0\Paths"</span><span class="w"> </span><span class="nt">-ValueName</span><span class="w"> </span><span class="s2">"C:\Windows\System32\cmd.exe"</span><span class="w"> </span><span class="nt">-Type</span><span class="w"> </span><span class="nx">DWord</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">0x4</span><span class="w">
</span><span class="n">Set-GPRegistryValue</span><span class="w"> </span><span class="nt">-Guid</span><span class="w"> </span><span class="nv">$CmdPowerShellRestrictionGPO</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Policies\Microsoft\Windows\Safer\CodeIdentifiers\0\Paths"</span><span class="w"> </span><span class="nt">-ValueName</span><span class="w"> </span><span class="s2">"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"</span><span class="w"> </span><span class="nt">-Type</span><span class="w"> </span><span class="nx">DWord</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">0x4</span><span class="w">

</span><span class="c"># Linking GPO to the "QA testers" OU</span><span class="w">
</span><span class="nv">$OUDistinguishedName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"OU=QA testers,DC=dc,DC=lab,DC=local"</span><span class="w">  </span><span class="c"># Replace with your actual OU</span><span class="w">
</span><span class="n">New-GPLink</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"CmdPowerShellRestrictionLink"</span><span class="w"> </span><span class="nt">-Target</span><span class="w"> </span><span class="nv">$OUDistinguishedName</span><span class="w"> </span><span class="nt">-LinkEnabled</span><span class="w"> </span><span class="nx">Yes</span><span class="w"> </span><span class="nt">-GPOName</span><span class="w"> </span><span class="s2">"CmdPowerShellRestriction"</span><span class="w">
</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/gpo.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/gpo.png" alt="GPO" class="lazyload" data-proofer-ignore></a></p><p>To force a <code class="language-plaintext highlighter-rouge">Group Policy update</code> on a local machine, you can use the following command:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">gpupdate</span><span class="w"> </span><span class="nx">/force</span><span class="w">
</span><span class="c"># Or </span><span class="w">
</span><span class="n">Invoke-GPUpdate</span><span class="w"> </span><span class="nt">-Computer</span><span class="w"> </span><span class="nx">ComputerName</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></pre></table></code></div></div><p><em><span style="color:red"> Note </span>: Ensure to perform this step on every local machine (both clients) to update the Group Policy Objects (GPO) promptly.</em></p><h2 id="8-adding-machines-to-the-domain"><span class="mr-2"><strong><strong><font color="Brown">8. Adding Machines to the Domain</font></strong></strong></span><a href="#8-adding-machines-to-the-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As we progress in our <code class="language-plaintext highlighter-rouge">Active Directory</code> journey, the next phase involves integrating client machines into the domain. This crucial step sets the foundation for a unified network under the watchful eye of our Active Directory infrastructure.</p><h3 id="preparing-the-client-machine-"><span class="mr-2">Preparing the Client Machine :</span><a href="#preparing-the-client-machine-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Ensure the client machine has a valid <code class="language-plaintext highlighter-rouge">IP address</code> and can communicate with the domain controller.</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/clinet_1_01.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/clinet_1_01.png" alt="IP add config client 1" class="lazyload" data-proofer-ignore></a></p><p>Confirm that the DNS settings on the client point to the Active Directory domain controller.</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/dns_clinet1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/dns_clinet1.png" alt="DNS config clinet 1" class="lazyload" data-proofer-ignore></a></p><h3 id="joining-the-domain"><span class="mr-2">Joining the Domain:</span><a href="#joining-the-domain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To join a machine to a domain in Windows, we use use the Add-Computer <code class="language-plaintext highlighter-rouge">PowerShell</code> cmdlet :</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">Add-Computer</span><span class="w"> </span><span class="nt">-DomainName</span><span class="w"> </span><span class="nx">dc.lab.local</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nx">dc.lab.local\Administrator</span><span class="w"> </span><span class="nt">-Restart</span><span class="w">

</span></pre></table></code></div></div><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/join_to_domain.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/join_to_domain.png" alt="add client 1 to domain" class="lazyload" data-proofer-ignore></a></p><p>If everything is alright, the machine will restart, indicating that we have successfully added the machine <code class="language-plaintext highlighter-rouge">user-1</code> to our domain <code class="language-plaintext highlighter-rouge">dc.lab.local</code>.</p><h3 id="verification"><span class="mr-2">Verification:</span><a href="#verification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After the machine has restarted, we can now log in with our user that we just added to the domain: <code class="language-plaintext highlighter-rouge">bob.smith</code> with the password <code class="language-plaintext highlighter-rouge">Bob@2023!</code></p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/bob_login.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/bob_login.png" alt="login with bob" class="lazyload" data-proofer-ignore></a></p><p>And in just a few minutes, the account setup will be complete.</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/setup_account.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/setup_account.png" alt="setup_account" class="lazyload" data-proofer-ignore></a></p><p>Verify the machineâ€™s domain membership in the <code class="language-plaintext highlighter-rouge">Acive Directory Users and Computers</code> :</p><p><a href="/assets/img/favicons/HackTheBox/ADDC-LAB/verify_the_machine.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/ADDC-LAB/verify_the_machine.png" alt="verify" class="lazyload" data-proofer-ignore></a></p><p><strong><code class="language-plaintext highlighter-rouge">Scenario</code></strong> : Bob, a Developer, is tasked with joining his Dev machine to the domain. Following the outlined steps, He is successfully integrates the machine into the <code class="language-plaintext highlighter-rouge">TechSecure Corp</code> domain.</p><p>You can follow the same steps to add client 2 to the domain.</p><h2 id="9-pentesting-tools-installation"><span class="mr-2">9. Pentesting Tools Installation</span><a href="#9-pentesting-tools-installation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As we gear up for the exciting realm of <code class="language-plaintext highlighter-rouge">penetration testing</code>, the installation of essential tools becomes paramount. This segment focuses on deploying common penetration testing tools such as <a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a>, <a href="https://github.com/fortra/impacket">impacket</a> and <a href="https://www.wireshark.org/download.html">Wireshark</a>, ensuring our arsenal is well-equipped for comprehensive security assessments.</p><p>I have created a table of <code class="language-plaintext highlighter-rouge">tools</code> that we will use in part two of this blog.</p><div class="table-wrapper"><table><thead><tr><th>Tools<th>Description<tbody><tr><td><a href="https://github.com/fortra/impacket">Impacket</a><td>Impacket is a collection of Python classes for working with network protocols.<tr><td><a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a><td>PowerSploit is a collection of Microsoft PowerShell modules that can be used to aid penetration testers during all phases of an assessment.<tr><td><a href="https://github.com/Flangvik/SharpCollection">SharpCollection</a><td>SharpCollection, Nightly builds of common C# offensive tools,<tr><td>Â <td>Â </table></div><h2 id="10-conclusion"><span class="mr-2">10. Conclusion</span><a href="#10-conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As we wrap up our <code class="language-plaintext highlighter-rouge">Active Directory</code> journey for <code class="language-plaintext highlighter-rouge">penetration testing</code>, letâ€™s take a moment to reflect on the key steps and considerations that have shaped our exploration. This concluding chapter serves as a compass, guiding us through the intricate terrain of securing our network environment.</p><h3 id="recap-of-key-steps"><span class="mr-2">Recap of Key Steps:</span><a href="#recap-of-key-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">Active Directory Domain Controller Setup: </code> Successfully installed and configured the Active Directory Domain Controller, establishing the foundation for our secure network.</p><p><code class="language-plaintext highlighter-rouge">User and Group Management: </code> Implemented robust user and group management strategies, tailoring permissions and access based on roles within the organization.</p><p><code class="language-plaintext highlighter-rouge">Create Organizational Units (OU):</code> Organized users by adding them to OUs, making it simpler to link them with Group Policy Objects (GPO).</p><p><code class="language-plaintext highlighter-rouge">Group Policy Configuration: </code> Strengthened security through Group Policy Configuration, enforcing password complexity, account lockout policies, and even restricting command-line access for specific user groups.</p><p><code class="language-plaintext highlighter-rouge">Adding Machines to the Domain: </code> Integrated client machines seamlessly into the domain, fostering a unified network environment.</p><p><code class="language-plaintext highlighter-rouge">Pentesting Tools Installation: </code> Installed essential penetration testing tools like Impacket and Bloodhound , equipping our lab for comprehensive security assessments.</p><h3 id="encouragement"><span class="mr-2">Encouragement:</span><a href="#encouragement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As you embark on your <code class="language-plaintext highlighter-rouge">penetration testing</code> endeavors, remember that responsible and ethical use of your lab is paramount. Each step you take contributes to your growth as a cybersecurity professional, and your commitment to ethical hacking enhances the overall security landscape.</p><p>Congratulations on completing this <code class="language-plaintext highlighter-rouge">Active Directory</code> journey! May your future exploits be both challenging and enlightening. Stay curious, stay secure, and keep pushing the boundaries of your cybersecurity expertise.</p><p>Thank you for joining me on this adventure. Until our paths cross again in the vast realm of cybersecurity!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ethical-hacking/'>Ethical Hacking</a>, <a href='/categories/ad-dc/'>AD DC</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >Active Directory</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Active%20Directory%20Mastery%20-%20A%20Guide%20to%20Windows%20Server%20Setup%20for%20Penetration%20Testing%20-%20Mostafa%20Toumi&url=%2Fposts%2FADDC-LAB-PART_01%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Active%20Directory%20Mastery%20-%20A%20Guide%20to%20Windows%20Server%20Setup%20for%20Penetration%20Testing%20-%20Mostafa%20Toumi&u=%2Fposts%2FADDC-LAB-PART_01%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FADDC-LAB-PART_01%2F&text=Active%20Directory%20Mastery%20-%20A%20Guide%20to%20Windows%20Server%20Setup%20for%20Penetration%20Testing%20-%20Mostafa%20Toumi" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2FADDC-LAB-PART_01%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Active%20Directory%20Mastery%20-%20A%20Guide%20to%20Windows%20Server%20Setup%20for%20Penetration%20Testing%20-%20Mostafa%20Toumi&url=%2Fposts%2FADDC-LAB-PART_01%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/LDAP/">LDAP Lightweight Directory Access Protocol</a><li><a href="/posts/HackTheBox-Sau/">HackTheBox-Sau Walkthrough</a><li><a href="/posts/DNS/">DNS Domain Name System</a><li><a href="/posts/ActiveDirectory_Management_with_Powershell/">Active Directory Management - A PowerShell Journey</a><li><a href="/posts/ADDC-LAB-PART_01/">Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dns/">DNS</a> <a class="post-tag" href="/tags/kerberos/">Kerberos</a> <a class="post-tag" href="/tags/ldap3/">ldap3</a> <a class="post-tag" href="/tags/ldap/">ldap</a> <a class="post-tag" href="/tags/ntlm/">NTLM</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/python3/">python3</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/DNS/"><div class="card-body"> <em class="small" data-ts="1669183200" data-df="ll" > Nov 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DNS Domain Name System</h3><div class="text-muted small"><p> DNS : Introduction: DNS (Domain Name System) is a fundamental protocol used on the internet and local networks to translate human-readable domain names into numerical IP addresses. It plays a cruc...</p></div></div></a></div><div class="card"> <a href="/posts/LDAP/"><div class="card-body"> <em class="small" data-ts="1669183200" data-df="ll" > Nov 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>LDAP Lightweight Directory Access Protocol</h3><div class="text-muted small"><p> LDAP Introduction to LDAP : LDAP Lightweight Directory Access Protocol is a widely used protocol for accessing and managing directory information. When integrated with Active Directory (AD), LDAP...</p></div></div></a></div><div class="card"> <a href="/posts/KERBEROS/"><div class="card-body"> <em class="small" data-ts="1669186800" data-df="ll" > Nov 23, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kerberos Active DIrectory</h3><div class="text-muted small"><p> Kerberos Introduction: What is Kerberos protocol : Kerberos is a network authentication protocol designed to provide secure authentication for users and services in a distributed computing envi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Create-a-Simple-Port-Scanner-with-python/" class="btn btn-outline-primary" prompt="Older"><p>How to Create a Simple Port Scanner With Python</p></a> <a href="/posts/DNS/" class="btn btn-outline-primary" prompt="Newer"><p>DNS Domain Name System</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dns/">DNS</a> <a class="post-tag" href="/tags/kerberos/">Kerberos</a> <a class="post-tag" href="/tags/ldap3/">ldap3</a> <a class="post-tag" href="/tags/ldap/">ldap</a> <a class="post-tag" href="/tags/ntlm/">NTLM</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/python3/">python3</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> Â© 2025 <a href="https://twitter.com/EmSec0">Mostafa Toumi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
